<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Salary Converter Widget</title>
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ffffff;
            color: #1d1d1f;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .widget-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .widget-logo {
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: #1d1d1f;
            text-decoration: none;
            display: inline-block;
            transition: opacity 0.2s;
        }

        .widget-logo:hover {
            opacity: 0.7;
        }

        .widget-logo span {
            color: #2563eb;
        }

        .widget-subtitle {
            font-size: 0.75rem;
            color: #86868b;
            margin-top: 4px;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid #d2d2d7;
            border-radius: 10px;
            font-size: 0.85rem;
            font-family: inherit;
            color: #1d1d1f;
            background: #ffffff;
            transition: border-color 0.2s, box-shadow 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2386868b' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 32px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .salary-input {
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .currency-hint {
            font-size: 0.7rem;
            color: #2563eb;
            margin-top: 4px;
            min-height: 16px;
        }

        .neighborhood-group {
            display: none;
            margin-top: 8px;
        }

        .neighborhood-group select {
            font-size: 0.8rem;
            padding: 8px 12px;
            border-color: #e8e8ed;
        }

        .section-divider {
            border: none;
            border-top: 1px solid #e8e8ed;
            margin: 16px 0;
        }

        .btn-calculate {
            width: 100%;
            padding: 12px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }

        .btn-calculate:hover {
            background: #1d4ed8;
        }

        .btn-calculate:active {
            transform: scale(0.98);
        }

        .result-box {
            display: none;
            margin-top: 16px;
            padding: 16px;
            background: #f5f5f7;
            border-radius: 14px;
            text-align: center;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .result-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1d1d1f;
            letter-spacing: -0.5px;
        }

        .result-breakdown {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .breakdown-stat {
            text-align: center;
        }

        .breakdown-stat-value {
            font-size: 0.8rem;
            font-weight: 600;
            color: #1d1d1f;
        }

        .breakdown-stat-label {
            font-size: 0.65rem;
            color: #86868b;
        }

        .result-note {
            font-size: 0.75rem;
            color: #86868b;
            margin-top: 10px;
            line-height: 1.4;
        }

        .result-note strong {
            color: #2563eb;
            font-weight: 600;
        }

        .error-msg {
            display: none;
            background: #fef2f2;
            color: #dc2626;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-bottom: 12px;
            text-align: center;
        }

        .widget-footer {
            text-align: center;
            margin-top: 18px;
            padding-top: 14px;
            border-top: 1px solid #e8e8ed;
        }

        .widget-footer a {
            font-size: 0.7rem;
            color: #86868b;
            text-decoration: none;
            transition: color 0.2s;
        }

        .widget-footer a:hover {
            color: #2563eb;
        }

        .widget-footer a strong {
            color: #1d1d1f;
            font-weight: 600;
        }

        .widget-footer a strong span {
            color: #2563eb;
        }

        .widget-footer-links {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 8px;
        }

        .widget-footer-links a {
            font-size: 0.65rem;
            color: #aeaeb2;
            text-decoration: none;
        }

        .widget-footer-links a:hover {
            color: #2563eb;
        }

        /* === EXPAT TOGGLE === */
        .expat-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            justify-content: center;
        }

        .expat-toggle-label {
            font-size: 0.7rem;
            font-weight: 500;
            color: #aeaeb2;
            cursor: pointer;
            transition: color 0.2s;
        }

        .expat-toggle-label.active {
            color: #1d1d1f;
            font-weight: 600;
        }

        .expat-toggle-track {
            width: 32px;
            height: 18px;
            background: #e8e8ed;
            border-radius: 9px;
            cursor: pointer;
            position: relative;
            transition: background 0.2s;
        }

        .expat-toggle-thumb {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
            transition: transform 0.2s;
        }

        /* === TAX SECTION === */
        .tax-section, .rent-section {
            display: none;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid #e8e8ed;
        }

        .rent-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .rent-card {
            background: #ffffff;
            border: 1px solid #e8e8ed;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
        }

        .rent-card-city {
            font-size: 0.65rem;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 4px;
        }

        .rent-card-amount {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1d1d1f;
        }

        .rent-card-usd {
            font-size: 0.7rem;
            color: #86868b;
        }

        .rent-card-label {
            font-size: 0.6rem;
            color: #aeaeb2;
            margin-top: 2px;
        }

        .section-title {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: #86868b;
            margin-bottom: 10px;
        }

        .tax-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .tax-card {
            background: #ffffff;
            border: 1px solid #e8e8ed;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
        }

        .tax-card-city {
            font-size: 0.7rem;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 4px;
        }

        .tax-card-gross, .tax-card-rate {
            font-size: 0.65rem;
            color: #86868b;
        }

        .tax-card-net {
            font-size: 1rem;
            font-weight: 700;
            color: #2563eb;
            margin-top: 4px;
        }

        .tax-card-label {
            font-size: 0.6rem;
            color: #86868b;
        }

        .ded-take-home-equiv {
            font-size: 0.65rem;
            color: #86868b;
            text-align: right;
            margin-top: 1px;
        }

        /* === AFFORDABILITY SECTION === */
        .affordability-section {
            display: none;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid #e8e8ed;
        }

        .afford-verdict {
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.78rem;
            font-weight: 600;
            line-height: 1.3;
        }

        .afford-verdict.better {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .afford-verdict.similar {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .afford-verdict.worse {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .afford-verdict-icon {
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .afford-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .afford-card {
            background: #ffffff;
            border: 1px solid #e8e8ed;
            border-radius: 10px;
            padding: 10px;
        }

        .afford-card-city {
            font-size: 0.6rem;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 8px;
        }

        .afford-card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
            font-size: 0.7rem;
            color: #6e6e73;
        }

        .afford-card-row.total {
            border-top: 1px solid #e8e8ed;
            margin-top: 4px;
            padding-top: 6px;
        }

        .afford-card-row.total .afford-card-val {
            font-size: 0.9rem;
            font-weight: 700;
        }

        .afford-card-row.total .afford-card-val.positive { color: #22c55e; }
        .afford-card-row.total .afford-card-val.negative { color: #ef4444; }

        .afford-card-val {
            font-weight: 600;
            color: #1d1d1f;
        }

        .afford-note {
            font-size: 0.6rem;
            color: #aeaeb2;
            margin-top: 6px;
            line-height: 1.4;
        }
        .afford-note a {
            color: #0071e3;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 2px;
        }
        .afford-note a:hover { text-decoration-style: solid; }

        .childcare-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            justify-content: center;
        }
        .childcare-toggle-label {
            font-size: 0.7rem;
            font-weight: 500;
            color: #aeaeb2;
            cursor: pointer;
            transition: color 0.2s;
        }
        .childcare-toggle-label.active {
            color: #1d1d1f;
            font-weight: 600;
        }
        .childcare-toggle-thumb {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
            transition: transform 0.2s;
        }

        .afford-card-row.separator {
            border-top: 1px dashed #e8e8ed;
            margin-top: 3px;
            padding-top: 3px;
        }
        .afford-card-row .afford-card-val.deduction { color: #aeaeb2; }

        /* === CHART SECTION === */
        .chart-section {
            display: none;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid #e8e8ed;
        }

        .chart-bar-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .chart-bar-label {
            font-size: 0.65rem;
            font-weight: 500;
            color: #86868b;
            width: 70px;
            text-align: right;
            flex-shrink: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chart-bar-track {
            flex: 1;
            height: 22px;
            background: #e8e8ed;
            border-radius: 6px;
            overflow: hidden;
        }

        .chart-bar-fill {
            height: 100%;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 6px;
            font-size: 0.6rem;
            font-weight: 600;
            color: white;
            min-width: 60px;
            transition: width 0.5s ease;
        }

        .chart-bar-fill.current {
            background: linear-gradient(90deg, #2563eb, #60a5fa);
        }

        .chart-bar-fill.target {
            background: linear-gradient(90deg, #8b5cf6, #c084fc);
        }

        .chart-bar-fill.tax-current {
            background: linear-gradient(90deg, #059669, #34d399);
        }

        .chart-bar-fill.tax-target {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        /* === SALARY RANGES === */
        .salary-ranges-section {
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid #e8e8ed;
        }

        .ranges-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .range-item {
            background: #ffffff;
            border: 1px solid #e8e8ed;
            border-radius: 8px;
            padding: 8px 10px;
        }

        .range-item-title {
            font-size: 0.65rem;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .range-item-bar {
            height: 4px;
            background: #e8e8ed;
            border-radius: 2px;
            position: relative;
            margin-bottom: 3px;
        }

        .range-item-bar-fill {
            position: absolute;
            height: 100%;
            border-radius: 2px;
            background: linear-gradient(90deg, #2563eb, #8b5cf6);
        }

        .range-item-mid {
            font-size: 0.7rem;
            font-weight: 700;
            color: #2563eb;
            text-align: center;
        }

        .range-item-values {
            display: flex;
            justify-content: space-between;
            font-size: 0.55rem;
            color: #aeaeb2;
        }

        /* === EXPLANATION SECTION === */
        .explanation-section {
            display: none;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid #e8e8ed;
        }

        .explanation-step {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 0.75rem;
            line-height: 1.4;
            color: #48484a;
        }

        .explanation-step:last-child {
            margin-bottom: 0;
        }

        .step-num {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #2563eb;
            color: white;
            font-size: 0.6rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 1px;
        }

        .step-text strong {
            color: #1d1d1f;
        }
    </style>
</head>
<body>

    <div class="widget-header">
        <a href="https://salary-converter.com" target="_blank" rel="noopener" class="widget-logo">salary<span>:</span>converter</a>
        <div class="widget-subtitle">Compare salaries across 101 cities & 2,100+ neighborhoods</div>
    </div>

    <div class="error-msg" id="errorMsg"></div>

    <!-- Current Salary -->
    <div class="form-group">
        <label class="form-label">Your Salary</label>
        <div class="form-row">
            <input type="text" id="salary" class="salary-input" placeholder="e.g. 75,000" inputmode="numeric">
            <select id="currentCurrency"></select>
        </div>
    </div>

    <!-- Current City -->
    <div class="form-group">
        <label class="form-label">Current City</label>
        <select id="currentCity">
            <option value="">Select city...</option>
        </select>
        <div class="neighborhood-group" id="currentNeighborhoodGroup">
            <label for="currentNeighborhood" style="font-size: 0.7rem; font-weight: 600; color: #86868b; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 4px;">Neighborhood</label>
            <select id="currentNeighborhood"></select>
        </div>
        <div class="currency-hint" id="currentHint"></div>
    </div>

    <hr class="section-divider">

    <!-- Target City -->
    <div class="form-group">
        <label class="form-label">Compare To</label>
        <select id="targetCity">
            <option value="">Select city...</option>
        </select>
        <div class="neighborhood-group" id="targetNeighborhoodGroup">
            <label for="targetNeighborhood" style="font-size: 0.7rem; font-weight: 600; color: #86868b; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 4px;">Neighborhood</label>
            <select id="targetNeighborhood"></select>
        </div>
        <div class="currency-hint" id="targetHint"></div>
    </div>

    <button class="btn-calculate" id="calcBtn">Check Equivalent Salary</button>

    <div class="result-box" id="resultBox">
        <div class="result-label">Equivalent Salary</div>
        <div class="result-amount" id="resultAmount"></div>
        <div class="result-breakdown">
            <div class="breakdown-stat">
                <div class="breakdown-stat-value" id="statRate"></div>
                <div class="breakdown-stat-label">Exchange Rate</div>
            </div>
            <div class="breakdown-stat">
                <div class="breakdown-stat-value" id="statCOL"></div>
                <div class="breakdown-stat-label">COL Adjustment</div>
            </div>
            <div class="breakdown-stat">
                <div class="breakdown-stat-value" id="statPower"></div>
                <div class="breakdown-stat-label">Buying Power</div>
            </div>
        </div>
        <div class="result-note" id="resultNote"></div>

        <!-- Tax & Deductions -->
        <div class="tax-section" id="taxSection">
            <div class="section-title">Tax &amp; Deductions Breakdown</div>
            <div class="expat-toggle">
                <span class="expat-toggle-label active" id="localLabel" onclick="if(isExpatMode) toggleExpatMode()">Local</span>
                <div class="expat-toggle-track" onclick="toggleExpatMode()">
                    <div class="expat-toggle-thumb"></div>
                </div>
                <span class="expat-toggle-label" id="expatLabel" onclick="if(!isExpatMode) toggleExpatMode()">Expat</span>
            </div>
            <div class="tax-grid" id="taxGrid"></div>
            <div style="font-size: 0.6rem; color: #aeaeb2; margin-top: 6px; line-height: 1.3;">Includes income tax, social security, and local taxes. Toggle to compare expat rates.</div>
        </div>

        <!-- Estimated Rent -->
        <div class="rent-section" id="rentSection">
            <div class="section-title">Estimated Monthly Rent (1BR)</div>
            <div class="rent-grid" id="rentGrid"></div>
            <div style="font-size: 0.6rem; color: #aeaeb2; margin-top: 4px;">City avg adjusted for neighborhood. Actual rents vary.</div>
        </div>

        <!-- Affordability Verdict -->
        <div class="affordability-section" id="affordabilitySection">
            <div class="section-title">Affordability Verdict</div>
            <div class="childcare-toggle" id="childcareToggle" style="display: none;">
                <span class="childcare-toggle-label active" id="noChildcareLabel" onclick="if(includeChildcare) toggleChildcare()">Without Childcare</span>
                <div class="expat-toggle-track" onclick="toggleChildcare()">
                    <div class="childcare-toggle-thumb"></div>
                </div>
                <span class="childcare-toggle-label" id="childcareLabel" onclick="if(!includeChildcare) toggleChildcare()">With Childcare</span>
            </div>
            <div class="afford-verdict" id="affordVerdict"></div>
            <div class="afford-cards" id="affordCards"></div>
            <div class="afford-note" id="affordNote">Disposable = take-home minus rent, groceries, utilities, transport &amp; healthcare. All costs adjusted for neighborhood. These living costs are already factored into the COLI (Cost of Living Index) adjusted salary above — COLI measures relative price levels across cities (New York = 100) — this breakdown shows where your money goes. Sources: <a href="https://www.numbeo.com/cost-of-living/" target="_blank" rel="noopener">Numbeo</a>, <a href="https://data.oecd.org/healthres/health-spending.htm" target="_blank" rel="noopener">OECD</a>.</div>
        </div>

        <!-- Visual Chart -->
        <div class="chart-section" id="chartSection">
            <div class="section-title">Visual Comparison</div>
            <div id="chartBars"></div>
        </div>

        <!-- Salary Ranges by Role -->
        <div class="salary-ranges-section" id="salaryRangesSection" style="display: none;">
            <div class="section-title">Salary Ranges by Role</div>
            <div class="ranges-list" id="rangesList"></div>
        </div>

        <!-- How we calculated this -->
        <div class="explanation-section" id="explanationSection">
            <div class="section-title">How we calculated this</div>
            <div id="explanationSteps"></div>
        </div>
    </div>

    <div class="widget-footer">
        <a href="https://salary-converter.com" target="_blank" rel="noopener">Powered by <strong>salary<span>:</span>converter</strong></a>
        <div class="widget-footer-links">
            <a href="https://salary-converter.com/city/" target="_blank" rel="noopener">101 Cities</a>
            <a href="https://salary-converter.com/compare/" target="_blank" rel="noopener">City Comparisons</a>
            <a href="https://salary-converter.com/blog/" target="_blank" rel="noopener">Blog</a>
        </div>
    </div>

<script>
// === DATA ===
const coliData = {
    'New York': 100, 'San Francisco': 97.6, 'Los Angeles': 76.3, 'Chicago': 73.2,
    'Miami': 80.1, 'Austin': 64.8, 'Seattle': 79.5, 'Denver': 65.7, 'Boston': 82.4,
    'Washington DC': 79.8, 'Houston': 60.2, 'Toronto': 62.3, 'Vancouver': 65.4,
    'Montreal': 52.1, 'Mexico City': 32.5, 'Cancún': 35.8, 'Panama City': 42.3,
    'London': 87.5, 'Paris': 46.9, 'Amsterdam': 82.6, 'Berlin': 51.2, 'Munich': 61.5,
    'Dublin': 72.8, 'Brussels': 50.3, 'Luxembourg City': 68.4, 'Zurich': 122.4,
    'Geneva': 118.6, 'Edinburgh': 62.1, 'Nice': 52.7, 'Madrid': 38.0, 'Barcelona': 42.1,
    'Valencia': 33.5, 'Málaga': 31.2, 'Lisbon': 34.7, 'Porto': 30.1, 'Rome': 49.3,
    'Milan': 57.8, 'Athens': 30.6, 'Split': 31.8, 'Stockholm': 64.3, 'Copenhagen': 85.7,
    'Helsinki': 58.2, 'Oslo': 78.5, 'Vienna': 48.2, 'Prague': 30.6, 'Budapest': 26.1,
    'Warsaw': 28.4, 'Krakow': 23.8, 'Bucharest': 22.5, 'Tallinn': 28.9, 'Riga': 25.3,
    'Istanbul': 23.1, 'Tokyo': 77.3, 'Osaka': 62.8, 'Fukuoka': 51.4, 'Seoul': 68.9,
    'Hong Kong': 73.6, 'Taipei': 44.8, 'Shanghai': 46.2, 'Beijing': 43.5, 'Shenzhen': 41.9,
    'Guangzhou': 38.7, 'Singapore': 87.7, 'Bangkok': 37.2, 'Chiang Mai': 22.6,
    'Phuket': 30.5, 'Kuala Lumpur': 32.8, 'Ho Chi Minh City': 26.4, 'Hanoi': 24.1,
    'Manila': 26.8, 'Jakarta': 24.5, 'Bali (Denpasar)': 25.3, 'Phnom Penh': 24.8,
    'Mumbai': 22.3, 'Bangalore': 20.8, 'Delhi': 19.5, 'Chennai': 18.9, 'Sydney': 74.5,
    'Melbourne': 68.2, 'Perth': 63.5, 'Auckland': 60.8, 'Dubai': 72.4, 'Abu Dhabi': 67.8,
    'Doha': 69.5, 'Riyadh': 42.6, 'Tel Aviv': 81.3, 'Cape Town': 28.4, 'Nairobi': 24.7,
    'Lagos': 27.3, 'Cairo': 16.8, 'Marrakech': 19.2, 'Casablanca': 22.1,
    'São Paulo': 41.8, 'Buenos Aires': 25.6, 'Bogotá': 22.9, 'Lima': 25.8,
    'Santiago': 33.2, 'Medellín': 20.4, 'Montevideo': 32.5, 'San José (CR)': 31.2,
    'Playa del Carmen': 30.8
};

const exchangeRates = {
    'GBP': 1.0, 'USD': 1.328, 'EUR': 1.126, 'SGD': 1.73, 'JPY': 205.72, 'AED': 4.811,
    'THB': 41.157, 'AUD': 1.887, 'CAD': 1.798, 'CHF': 1.076, 'CNY': 8.94, 'HKD': 10.4,
    'INR': 110.5, 'MYR': 5.4, 'NZD': 2.14, 'SEK': 12.09, 'NOK': 13.34, 'DKK': 8.43,
    'CZK': 30.6, 'HUF': 477, 'PLN': 5.2, 'TRY': 42.5, 'BRL': 6.7, 'MXN': 22.5,
    'ZAR': 24.2, 'KRW': 1686, 'TWD': 42.0, 'IDR': 20500, 'VND': 33200, 'PHP': 74.5,
    'ILS': 4.78, 'EGP': 64.8, 'KES': 171.5, 'NGN': 2100, 'MAD': 12.9, 'ARS': 1480,
    'COP': 5520, 'PEN': 4.92, 'CLP': 1245, 'UYU': 55.8, 'CRC': 672, 'QAR': 4.84,
    'SAR': 4.98, 'PAB': 1.328, 'RON': 5.62
};

const cityToCurrency = {
    'New York': 'USD', 'San Francisco': 'USD', 'Los Angeles': 'USD', 'Chicago': 'USD',
    'Miami': 'USD', 'Austin': 'USD', 'Seattle': 'USD', 'Denver': 'USD', 'Boston': 'USD',
    'Washington DC': 'USD', 'Houston': 'USD', 'Toronto': 'CAD', 'Vancouver': 'CAD',
    'Montreal': 'CAD', 'Mexico City': 'MXN', 'Cancún': 'MXN', 'Panama City': 'USD',
    'London': 'GBP', 'Edinburgh': 'GBP', 'Paris': 'EUR', 'Amsterdam': 'EUR',
    'Berlin': 'EUR', 'Munich': 'EUR', 'Dublin': 'EUR', 'Brussels': 'EUR',
    'Luxembourg City': 'EUR', 'Nice': 'EUR', 'Zurich': 'CHF', 'Geneva': 'CHF',
    'Madrid': 'EUR', 'Barcelona': 'EUR', 'Valencia': 'EUR', 'Málaga': 'EUR',
    'Lisbon': 'EUR', 'Porto': 'EUR', 'Rome': 'EUR', 'Milan': 'EUR', 'Athens': 'EUR',
    'Split': 'EUR', 'Stockholm': 'SEK', 'Copenhagen': 'DKK', 'Helsinki': 'EUR',
    'Oslo': 'NOK', 'Vienna': 'EUR', 'Prague': 'CZK', 'Budapest': 'HUF', 'Warsaw': 'PLN',
    'Krakow': 'PLN', 'Bucharest': 'RON', 'Tallinn': 'EUR', 'Riga': 'EUR',
    'Istanbul': 'TRY', 'Tokyo': 'JPY', 'Osaka': 'JPY', 'Fukuoka': 'JPY', 'Seoul': 'KRW',
    'Hong Kong': 'HKD', 'Taipei': 'TWD', 'Shanghai': 'CNY', 'Beijing': 'CNY',
    'Shenzhen': 'CNY', 'Guangzhou': 'CNY', 'Singapore': 'SGD', 'Bangkok': 'THB',
    'Chiang Mai': 'THB', 'Phuket': 'THB', 'Kuala Lumpur': 'MYR',
    'Ho Chi Minh City': 'VND', 'Hanoi': 'VND', 'Manila': 'PHP', 'Jakarta': 'IDR',
    'Bali (Denpasar)': 'IDR', 'Phnom Penh': 'USD', 'Mumbai': 'INR', 'Bangalore': 'INR',
    'Delhi': 'INR', 'Chennai': 'INR', 'Sydney': 'AUD', 'Melbourne': 'AUD', 'Perth': 'AUD',
    'Auckland': 'NZD', 'Dubai': 'AED', 'Abu Dhabi': 'AED', 'Doha': 'QAR',
    'Riyadh': 'SAR', 'Tel Aviv': 'ILS', 'Cape Town': 'ZAR', 'Nairobi': 'KES',
    'Lagos': 'NGN', 'Cairo': 'EGP', 'Marrakech': 'MAD', 'Casablanca': 'MAD',
    'São Paulo': 'BRL', 'Buenos Aires': 'ARS', 'Bogotá': 'COP', 'Medellín': 'COP',
    'Lima': 'PEN', 'Santiago': 'CLP', 'Montevideo': 'UYU', 'San José (CR)': 'CRC',
    'Playa del Carmen': 'MXN'
};

const cityNeighborhoods = {
    'New York': {
        'Manhattan (Midtown)': 1.25, 'Manhattan (Upper East Side)': 1.30, 'Manhattan (Lower East Side)': 1.10,
        'Brooklyn (Williamsburg)': 1.05, 'Brooklyn (Park Slope)': 1.08, 'Brooklyn (Bushwick)': 0.88,
        'Queens (Astoria)': 0.90, 'Queens (Long Island City)': 0.95, 'Harlem': 0.82,
        'The Bronx': 0.72, 'Staten Island': 0.75, 'SoHo / Tribeca': 1.35
    },
    'San Francisco': {
        'Financial District': 1.20, 'SoMa': 1.15, 'Mission District': 1.05,
        'Castro': 1.08, 'Sunset District': 0.92, 'Richmond District': 0.90,
        'Nob Hill': 1.18, 'Pacific Heights': 1.25, 'Tenderloin': 0.78,
        'Oakland (Downtown)': 0.80, 'Oakland (Rockridge)': 0.88, 'Berkeley': 0.90
    },
    'Los Angeles': {
        'Santa Monica': 1.25, 'Beverly Hills': 1.40, 'Hollywood': 1.10,
        'Downtown LA': 1.05, 'Silver Lake': 1.08, 'Venice': 1.20,
        'Koreatown': 0.85, 'Echo Park': 0.90, 'Pasadena': 0.92,
        'Long Beach': 0.80, 'Culver City': 1.02, 'Burbank': 0.88
    },
    'Chicago': {
        'The Loop': 1.20, 'Lincoln Park': 1.15, 'Wicker Park': 1.08,
        'River North': 1.22, 'Gold Coast': 1.25, 'Lakeview': 1.05,
        'Logan Square': 0.92, 'Pilsen': 0.82, 'Hyde Park': 0.85,
        'Bridgeport': 0.78, 'Evanston': 0.95, 'Oak Park': 0.90
    },
    'Miami': {
        'South Beach': 1.30, 'Brickell': 1.25, 'Wynwood': 1.10,
        'Coconut Grove': 1.15, 'Coral Gables': 1.20, 'Downtown Miami': 1.08,
        'Little Havana': 0.78, 'North Miami': 0.82, 'Hialeah': 0.72,
        'Miami Beach': 1.22, 'Doral': 0.88, 'Kendall': 0.80
    },
    'Austin': {
        'Downtown': 1.25, 'South Congress (SoCo)': 1.18, 'East Austin': 1.05,
        'West Lake Hills': 1.30, 'Hyde Park': 1.08, 'Mueller': 1.02,
        'North Loop': 0.95, 'Round Rock': 0.80, 'Cedar Park': 0.78,
        'Pflugerville': 0.75, 'South Lamar': 1.10
    },
    'Seattle': {
        'Capitol Hill': 1.12, 'Downtown': 1.18, 'Queen Anne': 1.10,
        'Ballard': 1.05, 'Fremont': 1.08, 'University District': 0.88,
        'Beacon Hill': 0.85, 'West Seattle': 0.92, 'Columbia City': 0.90,
        'Bellevue': 1.15, 'Redmond': 1.05, 'Kirkland': 1.02
    },
    'Denver': {
        'LoDo (Lower Downtown)': 1.22, 'Cherry Creek': 1.28, 'Capitol Hill': 1.10,
        'RiNo (River North)': 1.15, 'Highlands': 1.12, 'Washington Park': 1.08,
        'Baker': 1.02, 'Park Hill': 0.90, 'Montbello': 0.72,
        'Aurora': 0.78, 'Lakewood': 0.85, 'Englewood': 0.82
    },
    'Boston': {
        'Back Bay': 1.30, 'Beacon Hill': 1.28, 'South End': 1.18,
        'North End': 1.12, 'Seaport': 1.25, 'Cambridge (Harvard Sq)': 1.15,
        'Cambridge (Kendall Sq)': 1.20, 'Somerville': 0.95, 'Jamaica Plain': 0.90,
        'Dorchester': 0.78, 'Allston/Brighton': 0.85, 'Brookline': 1.10
    },
    'Washington DC': {
        'Georgetown': 1.30, 'Dupont Circle': 1.20, 'Capitol Hill': 1.15,
        'Adams Morgan': 1.05, 'Logan Circle': 1.18, 'Navy Yard': 1.10,
        'Columbia Heights': 0.92, 'Foggy Bottom': 1.22, 'U Street': 1.08,
        'Anacostia': 0.72, 'Arlington (VA)': 1.05, 'Bethesda (MD)': 1.12
    },
    'Houston': {
        'River Oaks': 1.35, 'The Heights': 1.15, 'Montrose': 1.12,
        'Downtown': 1.18, 'Midtown': 1.10, 'Museum District': 1.08,
        'Upper Kirby': 1.05, 'EaDo': 0.95, 'Katy': 0.82,
        'Sugar Land': 0.85, 'Spring': 0.78, 'Pearland': 0.80
    },
    'Toronto': {
        'Yorkville': 1.30, 'King West': 1.22, 'Liberty Village': 1.10,
        'Queen West': 1.08, 'The Annex': 1.12, 'Leslieville': 0.95,
        'Kensington Market': 0.92, 'Etobicoke': 0.80, 'Scarborough': 0.75,
        'North York': 0.85, 'Downtown Core': 1.18, 'Danforth': 0.90
    },
    'Vancouver': {
        'Yaletown': 1.25, 'Kitsilano': 1.15, 'Gastown': 1.12,
        'West End': 1.10, 'Commercial Drive': 0.95, 'Mount Pleasant': 1.05,
        'East Van': 0.88, 'Burnaby': 0.82, 'Richmond': 0.85,
        'North Vancouver': 0.92, 'West Vancouver': 1.30, 'Surrey': 0.72
    },
    'Montreal': {
        'Plateau Mont-Royal': 1.18, 'Old Montreal': 1.22, 'Griffintown': 1.15,
        'Mile End': 1.08, 'Outremont': 1.20, 'Westmount': 1.30,
        'Villeray': 0.92, 'Rosemont': 0.95, 'Verdun': 0.88,
        'NDG (Notre-Dame-de-Grâce)': 0.90, 'Hochelaga': 0.78, 'Laval': 0.75
    },
    'Mexico City': {
        'Polanco': 1.35, 'Condesa': 1.22, 'Roma Norte': 1.18,
        'Santa Fe': 1.15, 'Coyoacán': 1.02, 'Del Valle': 0.95,
        'Narvarte': 0.88, 'Tlalpan': 0.78, 'Iztapalapa': 0.65,
        'Centro Histórico': 0.90, 'San Ángel': 1.10
    },
    'Cancún': {
        'Zona Hotelera': 1.35, 'Puerto Cancún': 1.28, 'Centro': 0.85,
        'SM 17 (Downtown)': 0.82, 'Alfredo V. Bonfil': 0.72, 'Playa Mujeres': 1.22,
        'Puerto Juárez': 0.90, 'Isla Mujeres': 1.15
    },
    'Panama City': {
        'Punta Pacífica': 1.30, 'Costa del Este': 1.25, 'Casco Viejo': 1.12,
        'Obarrio': 1.10, 'El Cangrejo': 1.02, 'San Francisco': 1.08,
        'Calidonia': 0.78, 'Juan Díaz': 0.72, 'Clayton': 1.05, 'Balboa': 0.92
    },
    'London': {
        'Mayfair': 1.45, 'Chelsea': 1.38, 'Kensington': 1.35,
        'Notting Hill': 1.28, 'Soho': 1.22, 'Shoreditch': 1.10,
        'Camden': 1.05, 'Islington': 1.12, 'Brixton': 0.88,
        'Hackney': 0.92, 'Peckham': 0.82, 'Canary Wharf': 1.15,
        'Greenwich': 0.90, 'Clapham': 0.95, 'Stratford': 0.78,
        'Marylebone': 1.32, 'Hampstead': 1.30
    },
    'Paris': {
        'Le Marais (3rd/4th)': 1.30, 'Saint-Germain (6th)': 1.35, 'Champs-Élysées (8th)': 1.40,
        'Montmartre (18th)': 0.92, 'Bastille (11th)': 1.05, 'Oberkampf (11th)': 1.02,
        'Belleville (20th)': 0.82, 'La Défense': 1.10, 'Pigalle (9th)': 0.95,
        'Nation (12th)': 0.88, 'Batignolles (17th)': 0.98, 'Boulogne-Billancourt': 1.08
    },
    'Amsterdam': {
        'Canal Ring (Centrum)': 1.30, 'Jordaan': 1.25, 'De Pijp': 1.10,
        'Oud-West': 1.15, 'Oud-Zuid': 1.28, 'Oost': 0.95,
        'Noord': 0.82, 'Nieuw-West': 0.75, 'Amstelveen': 0.88,
        'Zuidas': 1.20, 'Westerpark': 1.05
    },
    'Berlin': {
        'Mitte': 1.22, 'Prenzlauer Berg': 1.12, 'Kreuzberg': 1.08,
        'Friedrichshain': 1.02, 'Charlottenburg': 1.15, 'Neukölln': 0.85,
        'Schöneberg': 1.05, 'Wedding': 0.78, 'Tempelhof': 0.82,
        'Spandau': 0.72, 'Steglitz': 0.88, 'Grunewald': 1.30
    },
    'Munich': {
        'Altstadt-Lehel': 1.35, 'Maxvorstadt': 1.18, 'Schwabing': 1.22,
        'Bogenhausen': 1.15, 'Haidhausen': 1.10, 'Glockenbachviertel': 1.20,
        'Sendling': 0.92, 'Moosach': 0.82, 'Pasing': 0.85,
        'Neuhausen': 1.05, 'Berg am Laim': 0.88
    },
    'Dublin': {
        'Dublin 2 (City Centre)': 1.25, 'Dublin 4 (Ballsbridge)': 1.30,
        'Dublin 6 (Ranelagh)': 1.15, 'Dublin 8 (Portobello)': 1.08,
        'Dún Laoghaire': 1.10, 'Rathmines': 1.05, 'Drumcondra': 0.92,
        'Tallaght': 0.75, 'Clontarf': 1.02, 'Howth': 1.12
    },
    'Brussels': {
        'Ixelles': 1.18, 'Saint-Gilles': 1.05, 'Uccle': 1.22,
        'Sablon': 1.28, 'Etterbeek': 1.02, 'Schaerbeek': 0.85,
        'Molenbeek': 0.72, 'Woluwe-Saint-Pierre': 1.12, 'Forest': 0.88,
        'EU Quarter': 1.15, 'Auderghem': 0.95
    },
    'Luxembourg City': {
        'Ville Haute': 1.30, 'Kirchberg': 1.22, 'Belair': 1.18,
        'Limpertsberg': 1.15, 'Grund': 1.08, 'Bonnevoie': 0.88,
        'Gasperich': 1.05, 'Eich': 0.92, 'Hollerich': 0.85, 'Cessange': 0.90
    },
    'Zurich': {
        'Bahnhofstrasse': 1.35, 'Seefeld': 1.25, 'Enge': 1.18,
        'Niederdorf': 1.15, 'Wiedikon': 1.02, 'Oerlikon': 0.88,
        'Altstetten': 0.82, 'Hottingen': 1.12, 'Wipkingen': 0.95, 'Schwamendingen': 0.78
    },
    'Geneva': {
        'Eaux-Vives': 1.20, 'Champel': 1.25, 'Carouge': 1.05,
        'Plainpalais': 1.10, 'Pâquis': 0.92, 'Nations': 1.15,
        'Servette': 0.88, 'Meyrin': 0.78, 'Vernier': 0.75, 'Cologny': 1.35
    },
    'Edinburgh': {
        'New Town': 1.25, 'Old Town': 1.18, 'Stockbridge': 1.15,
        'Morningside': 1.10, 'Marchmont': 1.02, 'Leith': 0.90,
        'Portobello': 0.88, 'Bruntsfield': 1.08, 'Gorgie': 0.78, 'Corstorphine': 0.82
    },
    'Nice': {
        'Promenade des Anglais': 1.30, 'Old Nice (Vieux Nice)': 1.18, 'Cimiez': 1.15,
        'Port': 1.05, 'Libération': 0.90, 'Riquier': 0.85,
        'Saint-Roch': 0.82, "L'Ariane": 0.70, 'Fabron': 0.95, 'Mont Boron': 1.22
    },
    'Madrid': {
        'Salamanca': 1.30, 'Chamberí': 1.18, 'Malasaña': 1.10,
        'Chueca': 1.12, 'La Latina': 1.05, 'Lavapiés': 0.90,
        'Retiro': 1.15, 'Chamartín': 1.08, 'Vallecas': 0.72, 'Tetuán': 0.82, 'Moncloa': 1.02
    },
    'Barcelona': {
        'Eixample': 1.15, 'Gràcia': 1.08, 'Born / El Born': 1.20,
        'Gothic Quarter': 1.18, 'Barceloneta': 1.10, 'Poblenou': 1.02,
        'Raval': 0.88, 'Sants': 0.85, 'Sant Andreu': 0.78,
        'Sarrià-Sant Gervasi': 1.25, 'Horta-Guinardó': 0.80
    },
    'Valencia': {
        'El Carmen': 1.18, 'Ruzafa': 1.15, 'Eixample': 1.10,
        'Ciutat Vella': 1.12, 'El Cabanyal': 0.92, 'Benimaclet': 0.88,
        'Patraix': 0.82, 'Poblats Marítims': 0.85, 'Campanar': 0.90, 'Quatre Carreres': 0.78
    },
    'Málaga': {
        'Centro Histórico': 1.22, 'Soho': 1.15, 'Pedregalejo': 1.10,
        'El Palo': 0.92, 'Huelin': 0.88, 'Teatinos': 0.85,
        'La Malagueta': 1.18, 'Puerto de la Torre': 0.75, 'Churriana': 0.78, 'El Limonar': 1.12
    },
    'Lisbon': {
        'Chiado': 1.28, 'Príncipe Real': 1.25, 'Alfama': 1.10,
        'Bairro Alto': 1.15, 'Estrela / Lapa': 1.12, 'Avenidas Novas': 1.05,
        'Alcântara': 0.95, 'Benfica': 0.82, 'Amadora': 0.72,
        'Parque das Nações': 1.08, 'Campo de Ourique': 1.02
    },
    'Porto': {
        'Ribeira': 1.22, 'Foz do Douro': 1.25, 'Cedofeita': 1.10,
        'Boavista': 1.15, 'Bonfim': 0.95, 'Campanhã': 0.78,
        'Paranhos': 0.85, 'Ramalde': 0.82, 'Matosinhos': 0.90, 'Vila Nova de Gaia': 0.88
    },
    'Rome': {
        'Centro Storico': 1.30, 'Trastevere': 1.15, 'Prati': 1.18,
        'Testaccio': 1.05, 'Monti': 1.20, 'San Giovanni': 0.92,
        'EUR': 0.88, 'Pigneto': 0.85, 'Ostiense': 0.90, 'Garbatella': 0.82, 'Flaminio': 1.08
    },
    'Milan': {
        'Brera': 1.30, 'Navigli': 1.15, 'Porta Nuova': 1.25,
        'City Centre': 1.35, 'Isola': 1.10, 'Città Studi': 0.90,
        'Lambrate': 0.85, 'Bovisa': 0.78, 'San Siro': 0.88, 'Porta Venezia': 1.12
    },
    'Athens': {
        'Kolonaki': 1.30, 'Plaka': 1.18, 'Kifissia': 1.22,
        'Glyfada': 1.15, 'Pangrati': 1.02, 'Exarchia': 0.85,
        'Koukaki': 1.05, 'Nea Smyrni': 0.90, 'Piraeus': 0.78, 'Marousi': 0.95, 'Psyrri': 1.08
    },
    'Split': {
        'Diocletian\'s Palace': 1.25, 'Bačvice': 1.15, 'Manuš': 1.05,
        'Žnjan': 1.10, 'Firule': 1.02, 'Spinut': 0.90,
        'Sućidar': 0.82, 'Trstenik': 0.88, 'Mertojak': 0.92
    },
    'Stockholm': {
        'Östermalm': 1.32, 'Södermalm': 1.15, 'Kungsholmen': 1.10,
        'Vasastan': 1.12, 'Gamla Stan': 1.20, 'Djurgården': 1.18,
        'Hammarby Sjöstad': 1.05, 'Hägersten': 0.88, 'Farsta': 0.75,
        'Solna': 0.90, 'Nacka': 0.92, 'Lidingö': 1.08
    },
    'Copenhagen': {
        'Indre By (City Centre)': 1.28, 'Frederiksberg': 1.18, 'Nørrebro': 1.02,
        'Vesterbro': 1.10, 'Østerbro': 1.15, 'Christianshavn': 1.12,
        'Amager': 0.90, 'Valby': 0.85, 'Brønshøj': 0.80, 'Hellerup': 1.22, 'Nordvest': 0.78
    },
    'Helsinki': {
        'Kruununhaka': 1.25, 'Eira': 1.22, 'Punavuori': 1.15,
        'Kallio': 1.05, 'Töölö': 1.12, 'Ullanlinna': 1.18,
        'Vallila': 0.95, 'Sörnäinen': 0.88, 'Vuosaari': 0.75,
        'Espoo (Tapiola)': 0.92, 'Kontula': 0.72
    },
    'Oslo': {
        'Frogner': 1.30, 'Majorstuen': 1.18, 'Grünerløkka': 1.12,
        'Aker Brygge': 1.25, 'Sentrum': 1.15, 'St. Hanshaugen': 1.08,
        'Tøyen': 0.88, 'Sagene': 1.02, 'Grønland': 0.82, 'Stovner': 0.72, 'Bærum': 1.10
    },
    'Vienna': {
        'Innere Stadt (1st)': 1.35, 'Josefstadt (8th)': 1.15, 'Neubau (7th)': 1.12,
        'Wieden (4th)': 1.18, 'Mariahilf (6th)': 1.08, 'Landstraße (3rd)': 1.05,
        'Leopoldstadt (2nd)': 0.95, 'Favoriten (10th)': 0.75, 'Ottakring (16th)': 0.82,
        'Döbling (19th)': 1.20, 'Hietzing (13th)': 1.10
    },
    'Prague': {
        'Prague 1 (Old Town)': 1.30, 'Prague 2 (Vinohrady)': 1.18, 'Prague 3 (Žižkov)': 0.95,
        'Prague 5 (Smíchov)': 1.05, 'Prague 6 (Dejvice)': 1.12, 'Prague 7 (Holešovice)': 1.08,
        'Prague 4 (Nusle)': 0.88, 'Prague 8 (Karlín)': 1.02, 'Prague 9': 0.78, 'Prague 10': 0.82
    },
    'Budapest': {
        'District V (Belváros)': 1.30, 'District VI (Terézváros)': 1.15, 'District VII (Jewish Quarter)': 1.12,
        'District I (Buda Castle)': 1.22, 'District II (Buda Hills)': 1.18, 'District IX (Ferencváros)': 1.02,
        'District XIII': 1.05, 'District XI (Újbuda)': 0.92, 'District VIII (Józsefváros)': 0.82,
        'District XIV (Zugló)': 0.85, 'District III (Óbuda)': 0.88
    },
    'Warsaw': {
        'Śródmieście (Centre)': 1.25, 'Mokotów': 1.12, 'Żoliborz': 1.15,
        'Wilanów': 1.18, 'Wola': 1.05, 'Praga Północ': 0.88,
        'Ursynów': 0.85, 'Ochota': 0.95, 'Bielany': 0.82, 'Bemowo': 0.78, 'Targówek': 0.72
    },
    'Krakow': {
        'Old Town (Stare Miasto)': 1.28, 'Kazimierz': 1.18, 'Podgórze': 1.05,
        'Krowodrza': 0.95, 'Dębniki': 0.90, 'Zabłocie': 1.08,
        'Nowa Huta': 0.72, 'Prądnik Biały': 0.82, 'Bronowice': 0.85, 'Ruczaj': 0.88
    },
    'Bucharest': {
        'Dorobanți': 1.28, 'Primăverii': 1.25, 'Floreasca': 1.18,
        'Herăstrău': 1.22, 'Cotroceni': 1.10, 'Aviatorilor': 1.15,
        'Pipera': 1.02, 'Militari': 0.75, 'Rahova': 0.70, 'Tineretului': 0.88, 'Berceni': 0.78
    },
    'Tallinn': {
        'Old Town (Vanalinn)': 1.28, 'Kalamaja': 1.15, 'Kadriorg': 1.18,
        'Pirita': 1.10, 'Telliskivi': 1.12, 'Rotermanni': 1.08,
        'Kristiine': 0.92, 'Mustamäe': 0.82, 'Lasnamäe': 0.72, 'Nõmme': 0.88
    },
    'Riga': {
        'Old Riga (Vecrīga)': 1.25, 'Quiet Centre': 1.18, 'Āgenskalns': 1.05,
        'Mežaparks': 1.10, 'Grīziņkalns': 0.92, 'Teika': 0.95,
        'Purvciems': 0.78, 'Imanta': 0.75, 'Ziepniekkalns': 0.72, 'Torņakalns': 0.88
    },
    'Istanbul': {
        'Beşiktaş': 1.28, 'Nişantaşı': 1.35, 'Kadıköy': 1.15,
        'Bebek': 1.30, 'Cihangir': 1.18, 'Karaköy': 1.12,
        'Şişli': 1.05, 'Üsküdar': 0.92, 'Bakırköy': 0.88,
        'Fatih': 0.82, 'Beyoğlu': 1.08, 'Esenyurt': 0.65
    },
    'Tokyo': {
        'Minato (Roppongi)': 1.30, 'Shibuya': 1.25, 'Shinjuku': 1.18,
        'Chiyoda (Marunouchi)': 1.35, 'Meguro': 1.15, 'Setagaya': 1.08,
        'Nakano': 0.92, 'Suginami': 0.88, 'Koto (Toyosu)': 1.05,
        'Adachi': 0.75, 'Edogawa': 0.78, 'Bunkyo': 1.10
    },
    'Osaka': {
        'Kita (Umeda)': 1.22, 'Chuo (Namba)': 1.18, 'Tennoji': 1.08,
        'Fukushima': 1.10, 'Nishi': 1.05, 'Shinmachi': 1.02,
        'Sumiyoshi': 0.88, 'Higashiyodogawa': 0.82, 'Ikuno': 0.78, 'Sakai': 0.75
    },
    'Fukuoka': {
        'Tenjin': 1.20, 'Hakata': 1.15, 'Daimyo': 1.12,
        'Yakuin': 1.08, 'Ohori': 1.10, 'Nishijin': 0.92,
        'Hakozaki': 0.85, 'Kashii': 0.80, 'Noke': 0.78, 'Momochi': 1.05
    },
    'Seoul': {
        'Gangnam': 1.30, 'Itaewon': 1.15, 'Myeongdong': 1.20,
        'Hongdae': 1.08, 'Bukchon': 1.18, 'Yeouido': 1.12,
        'Sinchon': 0.92, 'Gwangjin': 0.88, 'Nowon': 0.75, 'Mapo': 1.02
    },
    'Hong Kong': {
        'Central': 1.40, 'The Peak': 1.50, 'Mid-Levels': 1.30,
        'Causeway Bay': 1.25, 'Tsim Sha Tsui': 1.15, 'Wan Chai': 1.18,
        'Mong Kok': 0.92, 'Sham Shui Po': 0.78, 'Tai Po': 0.72,
        'Sai Kung': 0.85, 'Discovery Bay': 1.10
    },
    'Taipei': {
        'Da\'an': 1.25, 'Xinyi': 1.30, 'Zhongshan': 1.12,
        'Songshan': 1.08, 'Zhongzheng': 1.10, 'Shilin': 0.92,
        'Beitou': 0.88, 'Neihu': 1.02, 'Wanhua': 0.82, 'Banqiao (New Taipei)': 0.78
    },
    'Shanghai': {
        'Jing\'an': 1.30, 'Xuhui (French Concession)': 1.28, 'Lujiazui (Pudong)': 1.25,
        'Huangpu (The Bund)': 1.22, 'Changning': 1.10, 'Hongkou': 0.92,
        'Yangpu': 0.88, 'Minhang': 0.82, 'Baoshan': 0.75, 'Putuo': 0.90
    },
    'Beijing': {
        'Chaoyang (CBD)': 1.28, 'Dongcheng': 1.22, 'Xicheng': 1.18,
        'Haidian (Zhongguancun)': 1.15, 'Shunyi': 1.08, 'Chaoyang (Sanlitun)': 1.25,
        'Fengtai': 0.82, 'Tongzhou': 0.75, 'Daxing': 0.72, 'Changping': 0.78
    },
    'Shenzhen': {
        'Nanshan (Shekou)': 1.25, 'Futian (CBD)': 1.22, 'Luohu': 1.05,
        'Nanshan (Tech Park)': 1.18, 'Bao\'an': 0.82, 'Longhua': 0.78,
        'Longgang': 0.72, 'Yantian': 0.85, 'Guangming': 0.75, 'Qianhai': 1.12
    },
    'Guangzhou': {
        'Tianhe': 1.22, 'Yuexiu': 1.10, 'Haizhu': 1.02,
        'Liwan': 0.92, 'Panyu': 0.82, 'Baiyun': 0.78,
        'Huangpu': 1.05, 'Nansha': 0.75, 'Zhujiang New Town': 1.18, 'Huadu': 0.72
    },
    'Singapore': {
        'Orchard Road': 1.30, 'Marina Bay': 1.35, 'Raffles Place': 1.25,
        'Holland Village': 1.12, 'Tiong Bahru': 1.10, 'Tanjong Pagar': 1.15,
        'Bukit Timah': 1.18, 'Clementi': 0.88, 'Woodlands': 0.75,
        'Tampines': 0.78, 'Jurong East': 0.80, 'Sentosa': 1.40
    },
    'Bangkok': {
        'Sukhumvit (Asoke)': 1.25, 'Silom / Sathorn': 1.22, 'Siam': 1.18,
        'Thonglor': 1.28, 'Ekkamai': 1.15, 'Ari': 1.10,
        'Khao San': 0.85, 'On Nut': 0.88, 'Phra Khanong': 0.92,
        'Bang Na': 0.78, 'Chatuchak': 0.90, 'Ladprao': 0.82
    },
    'Chiang Mai': {
        'Old City': 1.15, 'Nimmanhaemin': 1.22, 'Santitham': 1.05,
        'Chang Khlan (Night Bazaar)': 1.08, 'Hang Dong': 0.82, 'San Sai': 0.78,
        'Mae Rim': 0.85, 'Suthep': 1.02, 'Wualai': 0.92, 'San Kamphaeng': 0.75
    },
    'Phuket': {
        'Patong': 1.22, 'Kata': 1.12, 'Karon': 1.08,
        'Kamala': 1.15, 'Surin': 1.20, 'Bang Tao': 1.18,
        'Phuket Town': 0.85, 'Rawai': 0.92, 'Chalong': 0.88, 'Cherng Talay': 1.05
    },
    'Kuala Lumpur': {
        'KLCC': 1.30, 'Bukit Bintang': 1.22, 'Bangsar': 1.18,
        'Mont Kiara': 1.15, 'Damansara Heights': 1.20, 'Sri Hartamas': 1.08,
        'Petaling Jaya': 0.90, 'Cheras': 0.78, 'Sentul': 0.82,
        'Kepong': 0.75, 'Desa ParkCity': 1.10
    },
    'Ho Chi Minh City': {
        'District 1': 1.30, 'District 2 (Thao Dien)': 1.22, 'District 3': 1.15,
        'District 7 (Phu My Hung)': 1.12, 'Binh Thanh': 1.02, 'District 4': 0.90,
        'Go Vap': 0.82, 'Tan Binh': 0.85, 'Thu Duc': 0.88, 'Binh Tan': 0.72
    },
    'Hanoi': {
        'Hoan Kiem (Old Quarter)': 1.25, 'Ba Dinh': 1.18, 'Tay Ho (West Lake)': 1.22,
        'Hai Ba Trung': 1.08, 'Dong Da': 1.02, 'Cau Giay': 1.05,
        'Thanh Xuan': 0.88, 'Ha Dong': 0.78, 'Long Bien': 0.82, 'Hoang Mai': 0.85
    },
    'Manila': {
        'Makati (CBD)': 1.28, 'BGC (Taguig)': 1.25, 'Rockwell': 1.22,
        'Alabang': 1.10, 'Ortigas': 1.08, 'Eastwood (Quezon City)': 1.02,
        'Pasig': 0.92, 'Mandaluyong': 0.95, 'Quezon City (Cubao)': 0.82,
        'Manila (Ermita)': 0.78, 'Las Piñas': 0.75
    },
    'Jakarta': {
        'Menteng': 1.30, 'Sudirman (SCBD)': 1.25, 'Kemang': 1.18,
        'Kuningan': 1.15, 'Senopati': 1.20, 'Pondok Indah': 1.12,
        'Kelapa Gading': 1.02, 'Pluit': 0.90, 'Cempaka Putih': 0.82,
        'Bekasi': 0.72, 'Tangerang': 0.75
    },
    'Bali (Denpasar)': {
        'Seminyak': 1.28, 'Canggu': 1.22, 'Ubud': 1.10,
        'Sanur': 1.05, 'Kuta': 0.92, 'Nusa Dua': 1.18,
        'Jimbaran': 1.12, 'Denpasar Centre': 0.82, 'Uluwatu': 1.15, 'Legian': 0.88
    },
    'Phnom Penh': {
        'BKK1': 1.30, 'BKK2': 1.10, 'Tonle Bassac': 1.22,
        'Daun Penh (Riverside)': 1.15, 'Toul Tom Poung (Russian Market)': 1.05,
        'Chroy Changvar': 0.90, 'Toul Kork': 0.95, 'Sen Sok': 0.78,
        'Meanchey': 0.72, 'Chamkarmon': 1.02
    },
    'Mumbai': {
        'South Mumbai (Colaba)': 1.35, 'Bandra West': 1.28, 'Juhu': 1.22,
        'Worli': 1.25, 'Lower Parel': 1.18, 'Andheri West': 1.05,
        'Powai': 1.08, 'Dadar': 0.95, 'Andheri East': 0.88,
        'Borivali': 0.78, 'Thane': 0.72, 'Navi Mumbai': 0.75
    },
    'Bangalore': {
        'Indiranagar': 1.25, 'Koramangala': 1.22, 'Whitefield': 1.08,
        'MG Road': 1.18, 'HSR Layout': 1.05, 'Jayanagar': 1.02,
        'Electronic City': 0.85, 'Marathahalli': 0.92, 'Yelahanka': 0.78,
        'Bannerghatta Road': 0.88, 'Hebbal': 0.95
    },
    'Delhi': {
        'South Delhi (GK)': 1.30, 'Lutyens Delhi': 1.40, 'Hauz Khas': 1.18,
        'Defence Colony': 1.22, 'Vasant Kunj': 1.08, 'Dwarka': 0.85,
        'Rohini': 0.78, 'Gurugram (DLF)': 1.12, 'Noida (Sector 18)': 0.82,
        'Saket': 1.05, 'Karol Bagh': 0.88
    },
    'Chennai': {
        'Adyar': 1.18, 'Nungambakkam': 1.22, 'T. Nagar': 1.10,
        'Anna Nagar': 1.05, 'Mylapore': 1.08, 'OMR (Sholinganallur)': 0.92,
        'Velachery': 0.88, 'Tambaram': 0.75, 'Porur': 0.82, 'Besant Nagar': 1.15
    },
    'Sydney': {
        'CBD': 1.25, 'Bondi': 1.22, 'Surry Hills': 1.15,
        'Darlinghurst': 1.12, 'Newtown': 1.05, 'Manly': 1.10,
        'Parramatta': 0.82, 'Bankstown': 0.72, 'Chatswood': 0.95,
        'Pyrmont': 1.18, 'Mosman': 1.28, 'Marrickville': 0.90
    },
    'Melbourne': {
        'CBD': 1.20, 'South Yarra': 1.22, 'Fitzroy': 1.10,
        'Carlton': 1.05, 'St Kilda': 1.08, 'Collingwood': 1.02,
        'Richmond': 0.98, 'Brunswick': 0.92, 'Footscray': 0.78,
        'Docklands': 1.12, 'Toorak': 1.30, 'Prahran': 1.08
    },
    'Perth': {
        'CBD': 1.18, 'Subiaco': 1.15, 'Cottesloe': 1.22,
        'Claremont': 1.12, 'Fremantle': 1.05, 'Leederville': 1.08,
        'Mount Lawley': 1.02, 'Northbridge': 0.95, 'Scarborough': 0.90,
        'Rockingham': 0.78, 'Joondalup': 0.82, 'Nedlands': 1.10
    },
    'Auckland': {
        'Ponsonby': 1.25, 'Parnell': 1.22, 'Herne Bay': 1.30,
        'Grey Lynn': 1.15, 'CBD': 1.12, 'Newmarket': 1.08,
        'Mt Eden': 1.05, 'Kingsland': 1.02, 'Devonport': 1.10,
        'Henderson': 0.78, 'Manukau': 0.72, 'Takapuna': 0.95
    },
    'Dubai': {
        'Downtown Dubai': 1.35, 'Dubai Marina': 1.28, 'Palm Jumeirah': 1.40,
        'JBR': 1.22, 'Business Bay': 1.18, 'DIFC': 1.30,
        'JLT': 1.05, 'Deira': 0.78, 'Al Barsha': 0.88,
        'Jumeirah': 1.15, 'Silicon Oasis': 0.72, 'Sports City': 0.80
    },
    'Abu Dhabi': {
        'Al Reem Island': 1.22, 'Saadiyat Island': 1.30, 'Corniche': 1.25,
        'Al Raha Beach': 1.15, 'Yas Island': 1.12, 'Khalifa City': 0.88,
        'Mussafah': 0.72, 'Al Khalidiya': 1.08, 'Tourist Club Area': 0.92, 'Al Ain': 0.78
    },
    'Doha': {
        'The Pearl': 1.35, 'West Bay': 1.28, 'Katara': 1.22,
        'Al Sadd': 1.05, 'Souq Waqif': 1.10, 'Lusail': 1.18,
        'Al Rayyan': 0.85, 'Al Wakrah': 0.78, 'Al Gharrafa': 0.82, 'Industrial Area': 0.65
    },
    'Riyadh': {
        'Al Olaya': 1.28, 'King Abdullah Financial District': 1.30, 'Al Nakheel': 1.18,
        'Diplomatic Quarter': 1.22, 'Al Malqa': 1.12, 'Al Yasmin': 1.05,
        'Al Sulimaniyah': 0.95, 'Al Batha': 0.72, 'Al Khaleej': 0.82, 'Al Thumama': 0.88
    },
    'Tel Aviv': {
        'Rothschild Blvd': 1.35, 'Neve Tzedek': 1.30, 'Florentin': 1.10,
        'Old North': 1.20, 'Sarona': 1.18, 'Jaffa': 0.95,
        'Ramat Aviv': 1.12, 'Bat Yam': 0.78, 'Holon': 0.75, 'Givatayim': 0.92
    },
    'Cape Town': {
        'Camps Bay': 1.35, 'Clifton': 1.40, 'Sea Point': 1.18,
        'City Bowl': 1.15, 'Green Point': 1.12, 'Woodstock': 0.92,
        'Observatory': 0.88, 'Rondebosch': 0.95, 'Claremont': 1.02,
        'Khayelitsha': 0.55, 'Mitchell\'s Plain': 0.60
    },
    'Nairobi': {
        'Westlands': 1.25, 'Karen': 1.22, 'Kilimani': 1.18,
        'Lavington': 1.15, 'Runda': 1.28, 'Kileleshwa': 1.10,
        'Upper Hill': 1.08, 'South B': 0.88, 'Eastleigh': 0.72,
        'Kibera': 0.55, 'Lang\'ata': 0.95
    },
    'Lagos': {
        'Victoria Island': 1.35, 'Ikoyi': 1.30, 'Lekki Phase 1': 1.22,
        'Banana Island': 1.45, 'Yaba': 0.88, 'Surulere': 0.82,
        'Ikeja': 0.90, 'Ajah': 0.78, 'Oshodi': 0.68, 'Maryland': 0.85, 'Gbagada': 0.92
    },
    'Cairo': {
        'Zamalek': 1.35, 'Garden City': 1.28, 'Maadi': 1.18,
        'Heliopolis': 1.08, 'New Cairo (5th Settlement)': 1.15, '6th of October City': 0.85,
        'Dokki': 1.02, 'Mohandessin': 0.95, 'Nasr City': 0.82, 'Shubra': 0.72, 'Downtown': 0.90
    },
    'Marrakech': {
        'Gueliz': 1.18, 'Hivernage': 1.25, 'Medina (Riads)': 1.15,
        'Palmeraie': 1.30, 'Agdal': 1.08, 'Targa': 1.02,
        'Massira': 0.78, 'Sidi Youssef Ben Ali': 0.72, 'Menara': 0.88, 'Amelkis': 1.12
    },
    'Casablanca': {
        'Corniche (Ain Diab)': 1.25, 'Maarif': 1.15, 'Anfa': 1.22,
        'Gauthier': 1.12, 'Bourgogne': 1.08, 'Racine': 1.05,
        'Sidi Moumen': 0.68, 'Hay Hassani': 0.78, 'Derb Sultan': 0.82, 'CIL': 0.88
    },
    'São Paulo': {
        'Jardins': 1.30, 'Vila Madalena': 1.15, 'Pinheiros': 1.18,
        'Itaim Bibi': 1.25, 'Vila Olímpia': 1.20, 'Moema': 1.12,
        'Centro': 0.78, 'Liberdade': 0.85, 'Bela Vista': 0.92,
        'Santana': 0.82, 'Tatuapé': 0.80
    },
    'Buenos Aires': {
        'Palermo (Soho)': 1.25, 'Recoleta': 1.28, 'Puerto Madero': 1.35,
        'San Telmo': 1.02, 'Belgrano': 1.10, 'Núñez': 1.05,
        'Caballito': 0.88, 'Almagro': 0.85, 'Flores': 0.75,
        'Villa Crespo': 0.92, 'Colegiales': 1.02
    },
    'Bogotá': {
        'Zona T (Zona Rosa)': 1.25, 'Usaquén': 1.22, 'Chicó': 1.20,
        'Chapinero Alto': 1.12, 'La Candelaria': 0.88, 'Cedritos': 1.02,
        'Suba': 0.82, 'Kennedy': 0.72, 'Teusaquillo': 0.95, 'Santa Bárbara': 1.15
    },
    'Lima': {
        'Miraflores': 1.28, 'San Isidro': 1.30, 'Barranco': 1.15,
        'Surco': 1.08, 'La Molina': 1.05, 'San Borja': 1.02,
        'Jesús María': 0.90, 'Lince': 0.85, 'San Juan de Lurigancho': 0.68, 'Callao': 0.72
    },
    'Santiago': {
        'Providencia': 1.22, 'Las Condes': 1.25, 'Vitacura': 1.35,
        'Ñuñoa': 1.08, 'La Reina': 1.05, 'Santiago Centro': 0.92,
        'Lo Barnechea': 1.18, 'Macul': 0.82, 'La Florida': 0.78, 'Puente Alto': 0.70
    },
    'Medellín': {
        'El Poblado': 1.30, 'Laureles': 1.12, 'Envigado': 1.08,
        'Sabaneta': 0.95, 'Belén': 0.88, 'La Floresta': 1.02,
        'Centro': 0.78, 'Robledo': 0.75, 'Aranjuez': 0.72, 'Estadio': 0.85
    },
    'Montevideo': {
        'Pocitos': 1.22, 'Punta Carretas': 1.25, 'Carrasco': 1.30,
        'Ciudad Vieja': 1.08, 'Parque Rodó': 1.05, 'Buceo': 1.02,
        'Cordón': 0.92, 'Tres Cruces': 0.88, 'La Blanqueada': 0.85, 'Cerro': 0.70
    },
    'San José (CR)': {
        'Escazú': 1.28, 'Santa Ana': 1.22, 'Rohrmoser': 1.12,
        'Los Yoses': 1.08, 'Barrio Escalante': 1.10, 'San Pedro': 0.92,
        'Sabana': 1.05, 'Heredia': 0.85, 'Alajuela': 0.78, 'Cartago': 0.75
    },
    'Playa del Carmen': {
        'Playacar': 1.30, 'Centro (5th Avenue)': 1.18, 'Gonzalo Guerrero': 1.05,
        'Ejidal': 0.82, 'Colosio': 0.78, 'Playa Mamitas': 1.22,
        'Zazil Ha': 0.88, 'Luis Donaldo Colosio': 0.75, 'Villas del Sol': 0.72
    }
};

const cityToCountry = {
    'New York': 'US', 'San Francisco': 'US', 'Los Angeles': 'US',
    'Chicago': 'US', 'Miami': 'US', 'Austin': 'US', 'Seattle': 'US',
    'Denver': 'US', 'Boston': 'US', 'Washington DC': 'US', 'Houston': 'US',
    'Toronto': 'CA', 'Vancouver': 'CA', 'Montreal': 'CA',
    'Mexico City': 'MX', 'Cancún': 'MX', 'Panama City': 'PA',
    'London': 'GB', 'Edinburgh': 'GB',
    'Paris': 'FR', 'Nice': 'FR',
    'Amsterdam': 'NL', 'Berlin': 'DE', 'Munich': 'DE',
    'Dublin': 'IE', 'Brussels': 'BE', 'Luxembourg City': 'LU',
    'Zurich': 'CH', 'Geneva': 'CH',
    'Madrid': 'ES', 'Barcelona': 'ES', 'Valencia': 'ES', 'Málaga': 'ES',
    'Lisbon': 'PT', 'Porto': 'PT', 'Rome': 'IT', 'Milan': 'IT',
    'Athens': 'GR', 'Split': 'HR',
    'Stockholm': 'SE', 'Copenhagen': 'DK', 'Helsinki': 'FI', 'Oslo': 'NO', 'Vienna': 'AT',
    'Prague': 'CZ', 'Budapest': 'HU', 'Warsaw': 'PL', 'Krakow': 'PL',
    'Bucharest': 'RO', 'Tallinn': 'EE', 'Riga': 'LV', 'Istanbul': 'TR',
    'Tokyo': 'JP', 'Osaka': 'JP', 'Fukuoka': 'JP',
    'Seoul': 'KR', 'Hong Kong': 'HK', 'Taipei': 'TW',
    'Shanghai': 'CN', 'Beijing': 'CN', 'Shenzhen': 'CN', 'Guangzhou': 'CN',
    'Singapore': 'SG', 'Bangkok': 'TH', 'Chiang Mai': 'TH', 'Phuket': 'TH',
    'Kuala Lumpur': 'MY', 'Ho Chi Minh City': 'VN', 'Hanoi': 'VN',
    'Manila': 'PH', 'Jakarta': 'ID', 'Bali (Denpasar)': 'ID', 'Phnom Penh': 'KH',
    'Mumbai': 'IN', 'Bangalore': 'IN', 'Delhi': 'IN', 'Chennai': 'IN',
    'Sydney': 'AU', 'Melbourne': 'AU', 'Perth': 'AU', 'Auckland': 'NZ',
    'Dubai': 'AE', 'Abu Dhabi': 'AE', 'Doha': 'QA', 'Riyadh': 'SA', 'Tel Aviv': 'IL',
    'Cape Town': 'ZA', 'Nairobi': 'KE', 'Lagos': 'NG', 'Cairo': 'EG',
    'Marrakech': 'MA', 'Casablanca': 'MA',
    'São Paulo': 'BR', 'Buenos Aires': 'AR', 'Bogotá': 'CO', 'Medellín': 'CO',
    'Lima': 'PE', 'Santiago': 'CL', 'Montevideo': 'UY',
    'San José (CR)': 'CR', 'Playa del Carmen': 'MX'
};

// Progressive income tax brackets by country [[upperBound, marginalRate%], ...]
const taxBrackets = {
    'AE': [], 'QA': [], 'SA': [], 'KH': [],
    'US': [[11600,10],[47150,12],[100525,22],[191950,24],[243725,32],[609350,35],[Infinity,37]],
    'CA': [[55867,15],[111733,20.5],[154906,26],[220000,29],[Infinity,33]],
    'MX': [[8952,1.92],[75985,6.4],[133536,10.88],[155230,16],[185853,17.92],[374838,21.36],[590797,23.52],[1127927,30],[1503902,32],[4511707,34],[Infinity,35]],
    'PA': [[11000,0],[50000,15],[Infinity,25]],
    'BR': [[24512,0],[33920,7.5],[45013,15],[55976,22.5],[Infinity,27.5]],
    'AR': [[419254,5],[838508,9],[1257762,12],[1677016,15],[2516524,19],[3356032,23],[5034048,27],[6712063,31],[Infinity,35]],
    'CO': [[46229000,0],[72066000,19],[163386000,28],[368076000,33],[624096000,35],[969456000,37],[Infinity,39]],
    'PE': [[29050,0],[54250,8],[81375,14],[116250,17],[232500,20],[Infinity,30]],
    'CL': [[8775702,0],[19501560,4],[32502600,8],[45503640,13.5],[58504680,23],[78006240,30.4],[101508120,35],[Infinity,40]],
    'UY': [[468720,0],[670320,10],[1005480,15],[1536000,24],[2421600,25],[3643200,27],[5685600,31],[Infinity,36]],
    'CR': [[11160000,0],[16380000,10],[Infinity,15]],
    'GB': [[12570,0],[50270,20],[125140,40],[Infinity,45]],
    'FR': [[11294,0],[28797,11],[82341,30],[177106,41],[Infinity,45]],
    'NL': [[38098,9.32],[75518,36.97],[Infinity,49.50]],
    'DE': [[11604,0],[17005,14],[66760,24],[277826,42],[Infinity,45]],
    'IE': [[42000,20],[Infinity,40]],
    'BE': [[15200,0],[28730,25],[40580,40],[Infinity,50]],
    'LU': [[11265,0],[25000,14],[50000,30],[100000,38],[200000,41],[Infinity,42]],
    'CH': [[14500,0],[50000,10],[100000,16],[200000,22],[Infinity,22]],
    'ES': [[12450,19],[20200,24],[35200,30],[60000,37],[300000,45],[Infinity,47]],
    'PT': [[7703,13.25],[11623,18],[16472,23],[21321,26],[27146,32.75],[39791,37],[51997,43.5],[81199,45],[Infinity,48]],
    'IT': [[15000,23],[28000,25],[50000,35],[Infinity,43]],
    'GR': [[10000,9],[20000,22],[30000,28],[40000,36],[Infinity,44]],
    'HR': [[50400,20],[Infinity,30]],
    'SE': [[614942,32],[Infinity,52]],
    'DK': [[46700,0],[588900,37],[Infinity,52]],
    'FI': [[19900,0],[29700,32.64],[49000,37.4],[85800,41.25],[Infinity,51.25]],
    'NO': [[198350,22],[279150,23.7],[642950,26],[926800,35.4],[1500000,38.4],[Infinity,39.4]],
    'AT': [[12816,0],[21816,20],[35016,30],[68016,40],[103816,48],[1000000,50],[Infinity,55]],
    'CZ': [[1935552,15],[Infinity,23]],
    'HU': [[Infinity,15]],
    'PL': [[30000,0],[120000,12],[Infinity,32]],
    'RO': [[Infinity,10]],
    'EE': [[7848,0],[Infinity,20]],
    'LV': [[20004,20],[78100,23],[Infinity,31]],
    'TR': [[110000,15],[230000,20],[580000,27],[3000000,35],[Infinity,40]],
    'JP': [[1950000,5],[3300000,10],[6950000,20],[9000000,23],[18000000,33],[40000000,40],[Infinity,45]],
    'KR': [[14000000,6],[50000000,15],[88000000,24],[150000000,35],[300000000,38],[500000000,40],[1000000000,42],[Infinity,45]],
    'HK': [[50000,2],[100000,6],[150000,10],[200000,14],[Infinity,17]],
    'TW': [[560000,5],[1260000,12],[2520000,20],[4720000,30],[Infinity,40]],
    'CN': [[36000,3],[144000,10],[300000,20],[420000,25],[660000,30],[960000,35],[Infinity,45]],
    'SG': [[20000,0],[30000,2],[40000,3.5],[80000,7],[120000,11.5],[160000,15],[200000,18],[240000,19],[280000,19.5],[320000,20],[500000,22],[1000000,23],[Infinity,24]],
    'TH': [[150000,0],[300000,5],[500000,10],[750000,15],[1000000,20],[2000000,25],[5000000,30],[Infinity,35]],
    'MY': [[5000,0],[20000,1],[35000,3],[50000,6],[70000,11],[100000,19],[400000,25],[600000,26],[2000000,28],[Infinity,30]],
    'VN': [[60000000,5],[120000000,10],[216000000,15],[384000000,20],[624000000,25],[960000000,30],[Infinity,35]],
    'PH': [[250000,0],[400000,15],[800000,20],[2000000,25],[8000000,30],[Infinity,35]],
    'ID': [[60000000,5],[250000000,15],[500000000,25],[5000000000,30],[Infinity,35]],
    'IN': [[300000,0],[700000,5],[1000000,10],[1200000,15],[1500000,20],[Infinity,30]],
    'AU': [[18200,0],[45000,16],[135000,30],[190000,37],[Infinity,45]],
    'NZ': [[14000,10.5],[48000,17.5],[70000,30],[180000,33],[Infinity,39]],
    'IL': [[84120,10],[120720,14],[193800,20],[269280,31],[560280,35],[721560,47],[Infinity,50]],
    'ZA': [[237100,18],[370500,26],[512800,31],[673000,36],[857900,39],[1817000,41],[Infinity,45]],
    'KE': [[288000,10],[388000,25],[6000000,30],[9600000,32.5],[Infinity,35]],
    'NG': [[300000,7],[600000,11],[1100000,15],[1600000,19],[3200000,21],[Infinity,24]],
    'EG': [[40000,0],[55000,10],[70000,15],[200000,20],[400000,22.5],[Infinity,25]],
    'MA': [[30000,0],[50000,10],[60000,20],[80000,30],[180000,34],[Infinity,38]]
};

function calculateTax(income, countryCode) {
    const brackets = taxBrackets[countryCode];
    if (!brackets || brackets.length === 0) return { tax: 0, effectiveRate: 0, net: income };
    let tax = 0, prev = 0;
    for (const [limit, rate] of brackets) {
        if (income <= prev) break;
        tax += (Math.min(income, limit) - prev) * (rate / 100);
        prev = limit;
    }
    const effectiveRate = income > 0 ? Math.round((tax / income) * 100) : 0;
    return { tax, effectiveRate, net: income - tax };
}

// Social security & deductions by country (ISO codes)
const countryDeductions = {
    'AE': {}, 'QA': {}, 'KH': {},
    'SA': {social_security: {local: 9.75, expat: 0, cap: null, label: 'GOSI'}},
    'US': {social_security: {local: 7.65, expat: 7.65, cap: 168600, label: 'FICA'}},
    'CA': {social_security: {local: 6.8, expat: 0, cap: 68500, label: 'CPP + EI'}},
    'MX': {social_security: {local: 2.78, expat: 0, cap: null, label: 'IMSS'}},
    'PA': {social_security: {local: 9.75, expat: 0, cap: null, label: 'CSS'}},
    'BR': {social_security: {local: 14, expat: 0, cap: 105432, label: 'INSS'}},
    'AR': {social_security: {local: 17, expat: 0, cap: null, label: 'Social Security'}},
    'CO': {social_security: {local: 8, expat: 0, cap: null, label: 'Health + Pension'}},
    'PE': {social_security: {local: 13, expat: 0, cap: null, label: 'ONP/AFP'}},
    'CL': {social_security: {local: 19.5, expat: 0, cap: null, label: 'AFP + Health'}},
    'UY': {social_security: {local: 18.1, expat: 0, cap: null, label: 'BPS'}},
    'CR': {social_security: {local: 10.67, expat: 0, cap: null, label: 'CCSS'}},
    'GB': {social_security: {local: 8, expat: 0, cap: 50270, reduced_rate: 2, label: 'National Insurance'}},
    'FR': {social_security: {local: 22, expat: 0, cap: null, label: 'Social Charges'}},
    'NL': {social_security: {local: 27.65, expat: 0, cap: 38098, label: 'Social Premiums'}},
    'DE': {social_security: {local: 20.2, expat: 20.2, cap: 90600, label: 'Social Security'}, solidarity: {rate: 5.5, of: 'income_tax', label: 'Solidarity'}},
    'IE': {social_security: {local: 4, expat: 0, cap: null, label: 'PRSI'}},
    'BE': {social_security: {local: 13.07, expat: 0, cap: null, label: 'Social Security'}},
    'LU': {social_security: {local: 12.45, expat: 12.45, cap: null, label: 'Social Security'}},
    'CH': {social_security: {local: 6.4, expat: 6.4, cap: null, label: 'AHV/IV/EO'}},
    'ES': {social_security: {local: 6.35, expat: 0, cap: 56646, label: 'Social Security'}},
    'PT': {social_security: {local: 11, expat: 0, cap: null, label: 'Social Security'}},
    'IT': {social_security: {local: 9.19, expat: 0, cap: 119650, label: 'INPS'}},
    'GR': {social_security: {local: 13.87, expat: 0, cap: null, label: 'Social Insurance'}},
    'HR': {social_security: {local: 20, expat: 0, cap: null, label: 'Pension + Health'}},
    'SE': {social_security: {local: 7, expat: 0, cap: null, label: 'Social Fees'}},
    'DK': {social_security: {local: 8, expat: 0, cap: null, label: 'AM-bidrag'}},
    'FI': {social_security: {local: 10.5, expat: 0, cap: null, label: 'Pension + Health'}},
    'NO': {social_security: {local: 7.8, expat: 0, cap: null, label: 'Trygdeavgift'}},
    'AT': {social_security: {local: 18.07, expat: 0, cap: 78660, label: 'Social Security'}},
    'CZ': {social_security: {local: 11, expat: 0, cap: null, label: 'Social + Health'}},
    'HU': {social_security: {local: 18.5, expat: 0, cap: null, label: 'Social Contribution'}},
    'PL': {social_security: {local: 13.71, expat: 0, cap: null, label: 'ZUS'}},
    'RO': {social_security: {local: 35, expat: 0, cap: null, label: 'CAS + CASS'}},
    'EE': {social_security: {local: 1.6, expat: 0, cap: null, label: 'Unemployment'}},
    'LV': {social_security: {local: 10.5, expat: 0, cap: null, label: 'Social Security'}},
    'TR': {social_security: {local: 15, expat: 0, cap: null, label: 'SSI'}},
    'JP': {social_security: {local: 14.75, expat: 14.75, cap: null, label: 'Health + Pension'}},
    'KR': {social_security: {local: 9.4, expat: 0, cap: null, label: 'NPS + Health'}},
    'HK': {social_security: {local: 5, expat: 0, cap: 18000, label: 'MPF'}},
    'TW': {social_security: {local: 5.17, expat: 0, cap: null, label: 'Labor + Health'}},
    'CN': {social_security: {local: 22.5, expat: 0, cap: null, label: 'Five Insurances'}},
    'SG': {social_security: {local: 20, expat: 0, cap: 102000, label: 'CPF'}},
    'TH': {social_security: {local: 5, expat: 0, cap: 180000, label: 'Social Security'}},
    'MY': {social_security: {local: 11, expat: 0, cap: null, label: 'EPF'}},
    'VN': {social_security: {local: 10.5, expat: 0, cap: null, label: 'Social + Health'}},
    'PH': {social_security: {local: 5, expat: 0, cap: null, label: 'SSS + PhilHealth'}},
    'ID': {social_security: {local: 5, expat: 0, cap: null, label: 'BPJS'}},
    'IN': {social_security: {local: 12, expat: 0, cap: 180000, label: 'PF + ESI'}},
    'AU': {},
    'NZ': {social_security: {local: 3, expat: 0, cap: null, label: 'KiwiSaver'}},
    'IL': {social_security: {local: 12, expat: 0, cap: null, label: 'NI + Health'}},
    'ZA': {social_security: {local: 1, expat: 0, cap: 17712, label: 'UIF'}},
    'KE': {social_security: {local: 6, expat: 0, cap: null, label: 'NSSF + NHIF'}},
    'NG': {social_security: {local: 8, expat: 0, cap: null, label: 'Pension + NHF'}},
    'EG': {social_security: {local: 11, expat: 0, cap: null, label: 'Social Insurance'}},
    'MA': {social_security: {local: 6.29, expat: 0, cap: null, label: 'CNSS'}}
};

const cityDedOverrides = {
    'New York': {state_tax: {rate: 10.3, label: 'NY State+City Tax'}},
    'San Francisco': {state_tax: {rate: 9.3, label: 'CA State Tax'}},
    'Los Angeles': {state_tax: {rate: 9.3, label: 'CA State Tax'}},
    'Chicago': {state_tax: {rate: 4.95, label: 'IL State Tax'}},
    'Austin': {state_tax: {rate: 0, label: 'No State Tax'}},
    'Miami': {state_tax: {rate: 0, label: 'No State Tax'}},
    'Seattle': {state_tax: {rate: 0, label: 'No State Tax'}},
    'Denver': {state_tax: {rate: 4.4, label: 'CO State Tax'}},
    'Boston': {state_tax: {rate: 9.0, label: 'MA State Tax'}},
    'Washington DC': {state_tax: {rate: 8.5, label: 'DC Tax'}},
    'Houston': {state_tax: {rate: 0, label: 'No State Tax'}},
    'Zurich': {cantonal_tax: {rate: 22, label: 'Cantonal Tax'}},
    'Geneva': {cantonal_tax: {rate: 26, label: 'Cantonal Tax'}},
    'Toronto': {provincial_tax: {rate: 9.15, label: 'Ontario Tax'}},
    'Vancouver': {provincial_tax: {rate: 7.7, label: 'BC Tax'}},
    'Montreal': {provincial_tax: {rate: 15, label: 'Québec Tax'}},
    'Berlin': {solidarity: {rate: 5.5, of: 'income_tax', label: 'Solidarity'}},
    'Munich': {solidarity: {rate: 5.5, of: 'income_tax', label: 'Solidarity'}},
    'London': {council_tax: {flat_annual: 1800, label: 'Council Tax'}},
    'Edinburgh': {council_tax: {flat_annual: 1500, label: 'Council Tax'}}
};

// Neighborhood-level deduction overrides (Tier 1: exact rates)
const nhoodDedOverrides = {
    'London': {
        'Mayfair':{council_tax:{flat_annual:972,label:'Council Tax (Westminster)'}},'Chelsea':{council_tax:{flat_annual:972,label:'Council Tax (K&C)'}},
        'Kensington':{council_tax:{flat_annual:972,label:'Council Tax (K&C)'}},'Soho':{council_tax:{flat_annual:972,label:'Council Tax (Westminster)'}},
        'Marylebone':{council_tax:{flat_annual:972,label:'Council Tax (Westminster)'}},'Notting Hill':{council_tax:{flat_annual:972,label:'Council Tax (K&C)'}},
        'Shoreditch':{council_tax:{flat_annual:1672,label:'Council Tax (Hackney)'}},'Hackney':{council_tax:{flat_annual:1672,label:'Council Tax (Hackney)'}},
        'Camden':{council_tax:{flat_annual:1942,label:'Council Tax (Camden)'}},'Islington':{council_tax:{flat_annual:1635,label:'Council Tax (Islington)'}},
        'Brixton':{council_tax:{flat_annual:1844,label:'Council Tax (Lambeth)'}},'Peckham':{council_tax:{flat_annual:1820,label:'Council Tax (Southwark)'}},
        'Canary Wharf':{council_tax:{flat_annual:1541,label:'Council Tax (Tower Hamlets)'}},'Greenwich':{council_tax:{flat_annual:1808,label:'Council Tax (Greenwich)'}},
        'Clapham':{council_tax:{flat_annual:1844,label:'Council Tax (Lambeth)'}},'Stratford':{council_tax:{flat_annual:1637,label:'Council Tax (Newham)'}},
        'Hampstead':{council_tax:{flat_annual:1942,label:'Council Tax (Camden)'}},'Battersea':{council_tax:{flat_annual:898,label:'Council Tax (Wandsworth)'}},
        'Fulham':{council_tax:{flat_annual:1375,label:'Council Tax (H&F)'}},'Wimbledon':{council_tax:{flat_annual:1694,label:'Council Tax (Merton)'}},
        'Ealing':{council_tax:{flat_annual:1765,label:'Council Tax (Ealing)'}},'Dalston':{council_tax:{flat_annual:1672,label:'Council Tax (Hackney)'}},
        'Tooting':{council_tax:{flat_annual:898,label:'Council Tax (Wandsworth)'}},'Walthamstow':{council_tax:{flat_annual:2050,label:'Council Tax (Waltham Forest)'}},
        'Richmond':{council_tax:{flat_annual:1994,label:'Council Tax (Richmond)'}},'Putney':{council_tax:{flat_annual:898,label:'Council Tax (Wandsworth)'}},
        'Chiswick':{council_tax:{flat_annual:1666,label:'Council Tax (Hounslow)'}},'Balham':{council_tax:{flat_annual:898,label:'Council Tax (Wandsworth)'}},
        'Lewisham':{council_tax:{flat_annual:1859,label:'Council Tax (Lewisham)'}},'Croydon':{council_tax:{flat_annual:2081,label:'Council Tax (Croydon)'}},
        'Barking':{council_tax:{flat_annual:1751,label:'Council Tax (Barking)'}},'Angel (Islington)':{council_tax:{flat_annual:1635,label:'Council Tax (Islington)'}},
        'Vauxhall':{council_tax:{flat_annual:1844,label:'Council Tax (Lambeth)'}},'Bermondsey':{council_tax:{flat_annual:1820,label:'Council Tax (Southwark)'}},
        'Kentish Town':{council_tax:{flat_annual:1942,label:'Council Tax (Camden)'}}
    },
    'Geneva': {
        'Eaux-Vives':{cantonal_tax:{rate:26,label:'Canton+Muni (Genève)'}},'Champel':{cantonal_tax:{rate:26,label:'Canton+Muni (Genève)'}},
        'Carouge':{cantonal_tax:{rate:25,label:'Canton+Muni (Carouge)'}},'Plainpalais':{cantonal_tax:{rate:26,label:'Canton+Muni (Genève)'}},
        'Pâquis':{cantonal_tax:{rate:26,label:'Canton+Muni (Genève)'}},'Nations':{cantonal_tax:{rate:26,label:'Canton+Muni (Genève)'}},
        'Servette':{cantonal_tax:{rate:26,label:'Canton+Muni (Genève)'}},'Meyrin':{cantonal_tax:{rate:27,label:'Canton+Muni (Meyrin)'}},
        'Vernier':{cantonal_tax:{rate:28,label:'Canton+Muni (Vernier)'}},'Cologny':{cantonal_tax:{rate:21,label:'Canton+Muni (Cologny)'}},
        'Florissant':{cantonal_tax:{rate:26,label:'Canton+Muni (Genève)'}},'Grand-Saconnex':{cantonal_tax:{rate:25,label:'Canton+Muni (Grand-Saconnex)'}},
        'Lancy':{cantonal_tax:{rate:27,label:'Canton+Muni (Lancy)'}},'Onex':{cantonal_tax:{rate:28,label:'Canton+Muni (Onex)'}},
        'Thônex':{cantonal_tax:{rate:27,label:'Canton+Muni (Thônex)'}},'Chêne-Bourg':{cantonal_tax:{rate:27,label:'Canton+Muni (Chêne-Bourg)'}},
        'Bernex':{cantonal_tax:{rate:27,label:'Canton+Muni (Bernex)'}},'Plan-les-Ouates':{cantonal_tax:{rate:25,label:'Canton+Muni (Plan-les-Ouates)'}}
    }
};
const scalableDed = new Set(['council_tax','property_tax']);

// Approximate monthly 1BR rent in city center (USD)
const cityRent1BR = {
    'New York':3500,'San Francisco':3200,'Los Angeles':2400,'Chicago':2000,
    'Miami':2500,'Austin':1800,'Seattle':2200,'Denver':1900,'Boston':2800,
    'Washington DC':2400,'Houston':1600,'Toronto':2000,'Vancouver':2100,
    'Montreal':1400,'Mexico City':700,'Cancún':600,'Panama City':1000,
    'London':2500,'Paris':1400,'Amsterdam':1800,'Berlin':1200,'Munich':1500,
    'Dublin':2000,'Brussels':1100,'Luxembourg City':1800,'Zurich':2800,
    'Geneva':2600,'Edinburgh':1300,'Nice':1100,
    'Madrid':1100,'Barcelona':1200,'Valencia':850,'Málaga':800,
    'Lisbon':1000,'Porto':800,'Rome':1200,'Milan':1400,'Athens':700,'Split':650,
    'Stockholm':1500,'Copenhagen':1800,'Helsinki':1200,'Oslo':1600,'Vienna':1000,
    'Prague':800,'Budapest':600,'Warsaw':700,'Krakow':550,'Bucharest':500,
    'Tallinn':650,'Riga':550,'Istanbul':450,
    'Tokyo':1500,'Osaka':1000,'Fukuoka':700,'Seoul':1200,'Hong Kong':2500,
    'Taipei':800,'Shanghai':1100,'Beijing':1000,'Shenzhen':900,'Guangzhou':750,
    'Singapore':2200,'Bangkok':600,'Chiang Mai':350,'Phuket':500,
    'Kuala Lumpur':550,'Ho Chi Minh City':500,'Hanoi':450,'Manila':500,
    'Jakarta':500,'Bali (Denpasar)':450,'Phnom Penh':450,
    'Mumbai':700,'Bangalore':400,'Delhi':350,'Chennai':300,
    'Sydney':2200,'Melbourne':1800,'Perth':1500,'Auckland':1400,
    'Dubai':1800,'Abu Dhabi':1500,'Doha':1600,'Riyadh':800,'Tel Aviv':1800,
    'Cape Town':650,'Nairobi':500,'Lagos':600,'Cairo':300,
    'Marrakech':350,'Casablanca':400,
    'São Paulo':600,'Buenos Aires':400,'Bogotá':400,'Lima':450,
    'Santiago':550,'Medellín':350,'Montevideo':500,
    'San José (CR)':550,'Playa del Carmen':500
};

const cityLivingCosts = {
    'New York':{groceries:550,utilities:330,transport:134,healthcare:450,childcare:2400},
    'San Francisco':{groceries:520,utilities:365,transport:87,healthcare:420,childcare:2500},
    'Los Angeles':{groceries:450,utilities:290,transport:100,healthcare:400,childcare:1800},
    'Chicago':{groceries:400,utilities:250,transport:105,healthcare:380,childcare:1600},
    'Miami':{groceries:420,utilities:280,transport:115,healthcare:400,childcare:1500},
    'Austin':{groceries:380,utilities:260,transport:42,healthcare:350,childcare:1300},
    'Seattle':{groceries:450,utilities:280,transport:100,healthcare:400,childcare:2000},
    'Denver':{groceries:400,utilities:230,transport:115,healthcare:370,childcare:1500},
    'Boston':{groceries:480,utilities:300,transport:90,healthcare:420,childcare:2200},
    'Washington DC':{groceries:470,utilities:280,transport:100,healthcare:400,childcare:2400},
    'Houston':{groceries:370,utilities:260,transport:45,healthcare:360,childcare:1200},
    'Toronto':{groceries:350,utilities:230,transport:110,healthcare:75,childcare:1100},
    'Vancouver':{groceries:360,utilities:200,transport:75,healthcare:75,childcare:1200},
    'Montreal':{groceries:320,utilities:180,transport:65,healthcare:50,childcare:200},
    'Mexico City':{groceries:250,utilities:115,transport:20,healthcare:50,childcare:475},
    'Cancún':{groceries:280,utilities:245,transport:28,healthcare:50,childcare:210},
    'Panama City':{groceries:300,utilities:180,transport:30,healthcare:60,childcare:500},
    'London':{groceries:400,utilities:415,transport:225,healthcare:50,childcare:2600},
    'Paris':{groceries:380,utilities:320,transport:105,healthcare:60,childcare:1450},
    'Amsterdam':{groceries:350,utilities:310,transport:100,healthcare:130,childcare:2400},
    'Berlin':{groceries:300,utilities:310,transport:50,healthcare:90,childcare:135},
    'Munich':{groceries:350,utilities:320,transport:60,healthcare:90,childcare:400},
    'Dublin':{groceries:350,utilities:280,transport:120,healthcare:50,childcare:1200},
    'Brussels':{groceries:340,utilities:280,transport:55,healthcare:80,childcare:975},
    'Luxembourg City':{groceries:380,utilities:300,transport:0,healthcare:80,childcare:1550},
    'Zurich':{groceries:550,utilities:325,transport:100,healthcare:400,childcare:3600},
    'Geneva':{groceries:530,utilities:310,transport:80,healthcare:400,childcare:3400},
    'Edinburgh':{groceries:320,utilities:290,transport:70,healthcare:30,childcare:1400},
    'Nice':{groceries:370,utilities:280,transport:50,healthcare:60,childcare:1000},
    'Madrid':{groceries:280,utilities:235,transport:55,healthcare:40,childcare:550},
    'Barcelona':{groceries:290,utilities:230,transport:45,healthcare:40,childcare:600},
    'Valencia':{groceries:250,utilities:210,transport:40,healthcare:35,childcare:400},
    'Málaga':{groceries:240,utilities:200,transport:40,healthcare:35,childcare:380},
    'Lisbon':{groceries:280,utilities:220,transport:45,healthcare:35,childcare:450},
    'Porto':{groceries:250,utilities:200,transport:40,healthcare:35,childcare:380},
    'Rome':{groceries:320,utilities:260,transport:40,healthcare:40,childcare:700},
    'Milan':{groceries:350,utilities:270,transport:40,healthcare:45,childcare:800},
    'Athens':{groceries:270,utilities:230,transport:35,healthcare:35,childcare:400},
    'Split':{groceries:280,utilities:230,transport:40,healthcare:30,childcare:350},
    'Stockholm':{groceries:350,utilities:200,transport:100,healthcare:40,childcare:180},
    'Copenhagen':{groceries:380,utilities:250,transport:60,healthcare:35,childcare:400},
    'Helsinki':{groceries:330,utilities:220,transport:65,healthcare:40,childcare:350},
    'Oslo':{groceries:400,utilities:370,transport:70,healthcare:30,childcare:235},
    'Vienna':{groceries:310,utilities:280,transport:55,healthcare:60,childcare:350},
    'Prague':{groceries:280,utilities:375,transport:24,healthcare:25,childcare:955},
    'Budapest':{groceries:240,utilities:250,transport:30,healthcare:25,childcare:500},
    'Warsaw':{groceries:260,utilities:270,transport:30,healthcare:25,childcare:550},
    'Krakow':{groceries:230,utilities:250,transport:25,healthcare:25,childcare:400},
    'Bucharest':{groceries:250,utilities:210,transport:20,healthcare:20,childcare:450},
    'Tallinn':{groceries:290,utilities:400,transport:35,healthcare:30,childcare:645},
    'Riga':{groceries:280,utilities:400,transport:35,healthcare:25,childcare:560},
    'Istanbul':{groceries:250,utilities:115,transport:75,healthcare:40,childcare:350},
    'Tokyo':{groceries:400,utilities:215,transport:78,healthcare:200,childcare:1100},
    'Osaka':{groceries:350,utilities:195,transport:65,healthcare:180,childcare:900},
    'Fukuoka':{groceries:320,utilities:180,transport:55,healthcare:170,childcare:800},
    'Seoul':{groceries:350,utilities:205,transport:45,healthcare:100,childcare:700},
    'Hong Kong':{groceries:450,utilities:260,transport:70,healthcare:60,childcare:1020},
    'Taipei':{groceries:300,utilities:120,transport:38,healthcare:40,childcare:650},
    'Shanghai':{groceries:350,utilities:130,transport:30,healthcare:50,childcare:800},
    'Beijing':{groceries:340,utilities:120,transport:25,healthcare:50,childcare:750},
    'Shenzhen':{groceries:320,utilities:110,transport:30,healthcare:45,childcare:700},
    'Guangzhou':{groceries:300,utilities:100,transport:25,healthcare:45,childcare:650},
    'Singapore':{groceries:380,utilities:200,transport:100,healthcare:150,childcare:1465},
    'Bangkok':{groceries:250,utilities:140,transport:38,healthcare:50,childcare:550},
    'Chiang Mai':{groceries:200,utilities:100,transport:58,healthcare:40,childcare:840},
    'Phuket':{groceries:240,utilities:145,transport:24,healthcare:45,childcare:645},
    'Kuala Lumpur':{groceries:220,utilities:120,transport:35,healthcare:40,childcare:400},
    'Ho Chi Minh City':{groceries:200,utilities:100,transport:12,healthcare:30,childcare:350},
    'Hanoi':{groceries:190,utilities:95,transport:10,healthcare:25,childcare:300},
    'Manila':{groceries:220,utilities:160,transport:15,healthcare:35,childcare:400},
    'Jakarta':{groceries:200,utilities:110,transport:15,healthcare:30,childcare:300},
    'Bali (Denpasar)':{groceries:180,utilities:70,transport:12,healthcare:30,childcare:160},
    'Phnom Penh':{groceries:220,utilities:150,transport:10,healthcare:30,childcare:635},
    'Mumbai':{groceries:150,utilities:75,transport:6,healthcare:25,childcare:200},
    'Bangalore':{groceries:140,utilities:80,transport:15,healthcare:25,childcare:180},
    'Delhi':{groceries:130,utilities:70,transport:10,healthcare:20,childcare:150},
    'Chennai':{groceries:120,utilities:65,transport:8,healthcare:20,childcare:130},
    'Sydney':{groceries:380,utilities:270,transport:145,healthcare:150,childcare:2100},
    'Melbourne':{groceries:350,utilities:250,transport:115,healthcare:150,childcare:2000},
    'Perth':{groceries:340,utilities:240,transport:120,healthcare:150,childcare:1800},
    'Auckland':{groceries:340,utilities:220,transport:125,healthcare:100,childcare:1200},
    'Dubai':{groceries:380,utilities:400,transport:87,healthcare:80,childcare:1200},
    'Abu Dhabi':{groceries:360,utilities:380,transport:80,healthcare:70,childcare:1100},
    'Doha':{groceries:350,utilities:215,transport:33,healthcare:50,childcare:775},
    'Riyadh':{groceries:300,utilities:180,transport:40,healthcare:50,childcare:600},
    'Tel Aviv':{groceries:420,utilities:250,transport:55,healthcare:80,childcare:1230},
    'Cape Town':{groceries:220,utilities:185,transport:55,healthcare:60,childcare:240},
    'Nairobi':{groceries:200,utilities:95,transport:31,healthcare:40,childcare:200},
    'Lagos':{groceries:180,utilities:100,transport:36,healthcare:30,childcare:670},
    'Cairo':{groceries:120,utilities:45,transport:7,healthcare:25,childcare:100},
    'Marrakech':{groceries:170,utilities:80,transport:10,healthcare:25,childcare:100},
    'Casablanca':{groceries:200,utilities:100,transport:25,healthcare:30,childcare:465},
    'São Paulo':{groceries:220,utilities:150,transport:55,healthcare:60,childcare:500},
    'Buenos Aires':{groceries:200,utilities:235,transport:20,healthcare:50,childcare:300},
    'Bogotá':{groceries:200,utilities:120,transport:39,healthcare:40,childcare:330},
    'Lima':{groceries:200,utilities:95,transport:20,healthcare:35,childcare:190},
    'Santiago':{groceries:250,utilities:160,transport:40,healthcare:60,childcare:500},
    'Medellín':{groceries:180,utilities:120,transport:60,healthcare:35,childcare:545},
    'Montevideo':{groceries:280,utilities:260,transport:72,healthcare:70,childcare:520},
    'San José (CR)':{groceries:280,utilities:180,transport:60,healthcare:70,childcare:695},
    'Playa del Carmen':{groceries:260,utilities:140,transport:28,healthcare:45,childcare:210}
};

const dedColors = {income_tax:'#ef4444',social_security:'#f59e0b',state_tax:'#8b5cf6',cantonal_tax:'#8b5cf6',provincial_tax:'#8b5cf6',solidarity:'#06b6d4',church_tax:'#06b6d4',council_tax:'#6b7280'};

const salaryRanges = {
    'Doctor (General)':{low:80000,mid:180000,high:350000},'Surgeon':{low:120000,mid:280000,high:500000},
    'Dentist':{low:70000,mid:160000,high:300000},'Pharmacist':{low:60000,mid:125000,high:200000},
    'Nurse':{low:30000,mid:58000,high:100000},'Psychologist':{low:45000,mid:85000,high:150000},
    'Software Engineer':{low:45000,mid:85000,high:180000},'DevOps Engineer':{low:50000,mid:95000,high:175000},
    'Data Scientist':{low:50000,mid:95000,high:170000},'Mechanical Engineer':{low:40000,mid:78000,high:140000},
    'Civil Engineer':{low:38000,mid:72000,high:135000},'Electrical Engineer':{low:42000,mid:80000,high:145000},
    'Architect':{low:38000,mid:72000,high:130000},'UX Designer':{low:40000,mid:75000,high:140000},
    'Product Manager':{low:55000,mid:100000,high:190000},'Project Manager':{low:45000,mid:80000,high:150000},
    'Financial Analyst':{low:42000,mid:78000,high:145000},'Accountant':{low:35000,mid:62000,high:110000},
    'Business Analyst':{low:42000,mid:75000,high:140000},'Consultant':{low:45000,mid:90000,high:180000},
    'Investment Banker':{low:80000,mid:150000,high:350000},'Actuary':{low:60000,mid:110000,high:200000},
    'Lawyer':{low:50000,mid:100000,high:220000},'Paralegal':{low:30000,mid:52000,high:85000},
    'Marketing Manager':{low:38000,mid:72000,high:135000},'Sales Manager':{low:40000,mid:80000,high:160000},
    'Graphic Designer':{low:30000,mid:55000,high:100000},'Content Writer':{low:25000,mid:50000,high:90000},
    'HR Manager':{low:38000,mid:70000,high:130000},'Operations Manager':{low:45000,mid:82000,high:150000},
    'CEO / Executive':{low:100000,mid:220000,high:500000},
    'Teacher':{low:25000,mid:48000,high:85000},'Professor':{low:50000,mid:95000,high:180000},
    'Research Scientist':{low:45000,mid:85000,high:155000},
    'Pilot':{low:50000,mid:120000,high:250000},'Chef':{low:25000,mid:50000,high:100000},
    'Journalist':{low:25000,mid:52000,high:95000}
};

function calculateAllDeductions(income, countryCode, cityName, isExpat, nhood) {
    if (income <= 0) return {items:[], total:0, totalRate:0, net:0};
    const items = [];
    const nhOvr = (nhood && nhoodDedOverrides[cityName]) ? (nhoodDedOverrides[cityName][nhood]||{}) : {};
    const nhMult = (nhood && cityNeighborhoods[cityName]) ? (cityNeighborhoods[cityName][nhood]||1.0) : 1.0;
    const taxResult = calculateTax(income, countryCode);
    items.push({key:'income_tax', label:'Income Tax', amount:taxResult.tax, rate:taxResult.effectiveRate});
    const cDed = countryDeductions[countryCode] || {};
    const ss = cDed.social_security;
    if (ss) {
        const ssRate = isExpat ? (ss.expat||0) : (ss.local||0);
        if (ssRate > 0) {
            const ssBase = ss.cap ? Math.min(income, ss.cap) : income;
            let ssAmt = ssBase * (ssRate/100);
            if (ss.reduced_rate && ss.cap && income > ss.cap) ssAmt += (income - ss.cap) * (ss.reduced_rate/100);
            items.push({key:'social_security', label:ss.label||'Social Security', amount:ssAmt, rate:Math.round((ssAmt/income)*1000)/10});
        }
    }
    const cityD = cityDedOverrides[cityName] || {};
    for (const k of ['state_tax','cantonal_tax','provincial_tax']) {
        const info = nhOvr[k] || cityD[k] || cDed[k];
        if (info && (info.rate||0) > 0) items.push({key:k, label:info.label, amount:income*(info.rate/100), rate:info.rate});
    }
    for (const k of ['solidarity','church_tax','council_tax']) {
        let levy = nhOvr[k];
        if (!levy) {
            const base = cityD[k] || cDed[k];
            if (!base) continue;
            if (scalableDed.has(k) && nhood && base.flat_annual) {
                levy = {flat_annual: Math.round(base.flat_annual * nhMult), label: base.label + ' (est.)'};
            } else { levy = base; }
        }
        if (levy.flat_annual) items.push({key:k, label:levy.label, amount:levy.flat_annual, rate:Math.round((levy.flat_annual/income)*1000)/10});
        else if (levy.of==='income_tax') { const a=taxResult.tax*(levy.rate/100); items.push({key:k, label:levy.label, amount:a, rate:Math.round((a/income)*1000)/10}); }
        else if (levy.rate) items.push({key:k, label:levy.label, amount:income*(levy.rate/100), rate:levy.rate});
    }
    const total = items.reduce((s,i)=>s+i.amount, 0);
    return {items, total, totalRate: income>0 ? Math.round((total/income)*1000)/10 : 0, net: income-total};
}

// === DOM REFS ===
const salaryInput = document.getElementById('salary');
const currentCity = document.getElementById('currentCity');
const targetCity = document.getElementById('targetCity');
const currentCurrency = document.getElementById('currentCurrency');
const currentHint = document.getElementById('currentHint');
const targetHint = document.getElementById('targetHint');
const currentNeighborhood = document.getElementById('currentNeighborhood');
const targetNeighborhood = document.getElementById('targetNeighborhood');
const calcBtn = document.getElementById('calcBtn');
const resultBox = document.getElementById('resultBox');
const resultAmount = document.getElementById('resultAmount');
const errorMsg = document.getElementById('errorMsg');
let isExpatMode = false;
let includeChildcare = false;

function toggleChildcare() {
    includeChildcare = !includeChildcare;
    document.getElementById('noChildcareLabel').classList.toggle('active', !includeChildcare);
    document.getElementById('childcareLabel').classList.toggle('active', includeChildcare);
    const thumb = document.querySelector('.childcare-toggle-thumb');
    thumb.style.transform = includeChildcare ? 'translateX(14px)' : 'translateX(0)';
    if (resultBox.style.display !== 'none' && resultBox.style.display !== '') {
        calculate();
    }
}

function toggleExpatMode() {
    isExpatMode = !isExpatMode;
    document.getElementById('localLabel').classList.toggle('active', !isExpatMode);
    document.getElementById('expatLabel').classList.toggle('active', isExpatMode);
    const thumb = document.querySelector('.expat-toggle-thumb');
    thumb.style.transform = isExpatMode ? 'translateX(14px)' : 'translateX(0)';
    // Re-trigger calculation
    if (resultBox.style.display !== 'none' && resultBox.style.display !== '') {
        calculate();
    }
}

// === INIT ===
function init() {
    const cities = Object.keys(coliData).sort();
    [currentCity, targetCity].forEach(sel => {
        cities.forEach(city => {
            const opt = document.createElement('option');
            opt.value = city;
            opt.textContent = city;
            sel.appendChild(opt);
        });
    });

    Object.keys(exchangeRates).sort().forEach(code => {
        const opt = document.createElement('option');
        opt.value = code;
        opt.textContent = code;
        currentCurrency.appendChild(opt);
    });
    currentCurrency.value = 'GBP';
}

// Populate neighborhood dropdown
function populateNeighborhoods(city, selectEl, groupEl) {
    selectEl.innerHTML = '<option value="">Select a neighborhood...</option>';
    const neighborhoods = cityNeighborhoods[city];
    if (neighborhoods) {
        const sorted = Object.entries(neighborhoods).sort((a, b) => b[1] - a[1]);
        sorted.forEach(([name, multiplier]) => {
            const opt = document.createElement('option');
            opt.value = name;
            const pct = ((multiplier - 1) * 100);
            const sign = pct >= 0 ? '+' : '';
            opt.textContent = `${name} (${sign}${pct.toFixed(0)}% vs avg)`;
            selectEl.appendChild(opt);
        });
        groupEl.style.display = 'block';
    } else {
        groupEl.style.display = 'none';
    }
}

// Auto-suggest currency on city change
currentCity.addEventListener('change', () => {
    const city = currentCity.value;
    const currency = cityToCurrency[city];
    if (currency) {
        currentCurrency.value = currency;
        currentHint.textContent = `Currency set to ${currency}`;
    } else {
        currentHint.textContent = '';
    }
    populateNeighborhoods(city, currentNeighborhood, document.getElementById('currentNeighborhoodGroup'));
    targetHint.textContent = '';
});

targetCity.addEventListener('change', () => {
    const city = targetCity.value;
    const currency = cityToCurrency[city];
    if (currency) {
        targetHint.textContent = `Will show result in ${currency}`;
    } else {
        targetHint.textContent = '';
    }
    populateNeighborhoods(city, targetNeighborhood, document.getElementById('targetNeighborhoodGroup'));
});

// Salary formatting
salaryInput.addEventListener('input', () => {
    let val = salaryInput.value.replace(/[^0-9]/g, '');
    if (val) {
        salaryInput.value = parseInt(val).toLocaleString('en-US');
    }
});

// Error display with scroll-to and field highlight
function showError(msg, field) {
    errorMsg.textContent = msg;
    errorMsg.style.display = 'block';
    resultBox.style.display = 'none';
    if (field) {
        field.scrollIntoView({ behavior: 'smooth', block: 'center' });
        field.style.borderColor = '#dc2626';
        field.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.15)';
        field.focus();
        setTimeout(() => {
            field.style.borderColor = '';
            field.style.boxShadow = '';
        }, 3000);
    }
    setTimeout(() => errorMsg.style.display = 'none', 4000);
}

// === CALCULATE ===
calcBtn.addEventListener('click', calculate);
salaryInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') calculate(); });

function calculate() {
    errorMsg.style.display = 'none';

    const salary = parseFloat(salaryInput.value.replace(/,/g, ''));
    const fromCity = currentCity.value;
    const toCity = targetCity.value;
    const fromCurrency = currentCurrency.value;

    if (!salary || salary <= 0) return showError('Please enter your salary', salaryInput);
    if (!fromCity) return showError('Please select your current city', currentCity);
    if (!toCity) return showError('Please select a city to compare', targetCity);
    if (fromCity === toCity && currentNeighborhood.value === targetNeighborhood.value) return showError('Please select two different locations', targetCity);
    if (cityNeighborhoods[fromCity] && !currentNeighborhood.value) return showError('Please select a neighborhood for your current city', currentNeighborhood);
    if (cityNeighborhoods[toCity] && !targetNeighborhood.value) return showError('Please select a neighborhood for your target city', targetNeighborhood);

    let fromCOLI = coliData[fromCity];
    let toCOLI = coliData[toCity];

    // Apply neighborhood multipliers
    const fromNhood = currentNeighborhood.value;
    const toNhood = targetNeighborhood.value;
    if (fromNhood && cityNeighborhoods[fromCity] && cityNeighborhoods[fromCity][fromNhood]) {
        fromCOLI *= cityNeighborhoods[fromCity][fromNhood];
    }
    if (toNhood && cityNeighborhoods[toCity] && cityNeighborhoods[toCity][toNhood]) {
        toCOLI *= cityNeighborhoods[toCity][toNhood];
    }

    const toCurrency = cityToCurrency[toCity] || fromCurrency;

    // Exchange rate: from → GBP → to
    const fromRate = exchangeRates[fromCurrency];
    const toRate = exchangeRates[toCurrency];
    const xRate = toRate / fromRate;

    // Equivalent salary
    const equivalent = salary * (toCOLI / fromCOLI) * xRate;

    // Buying power
    const converted = salary * xRate;
    const buyingPower = ((converted / equivalent) * 100).toFixed(0);

    // Format result
    const formatter = new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    });

    resultAmount.textContent = `${toCurrency} ${formatter.format(Math.round(equivalent))}`;

    // Breakdown
    document.getElementById('statRate').textContent = `1 ${fromCurrency} = ${xRate < 10 ? xRate.toFixed(3) : xRate.toFixed(1)} ${toCurrency}`;
    const colRatio = ((toCOLI / fromCOLI) * 100).toFixed(0);
    document.getElementById('statCOL').textContent = colRatio >= 100 ? `+${colRatio - 100}% higher` : `${100 - colRatio}% lower`;
    document.getElementById('statPower').textContent = `${buyingPower}%`;

    // Note
    const fromLabel = fromNhood ? `${fromNhood}, ${fromCity}` : fromCity;
    const toLabel = toNhood ? `${toNhood}, ${toCity}` : toCity;
    const note = toCOLI > fromCOLI
        ? `${toLabel} costs <strong>${Math.abs(colRatio - 100)}% more</strong> to live in than ${fromLabel}`
        : `${toLabel} costs <strong>${Math.abs(colRatio - 100)}% less</strong> to live in than ${fromLabel}`;
    document.getElementById('resultNote').innerHTML = note;

    // Currency formatter helper
    const fmtCur = (amount, cur) => new Intl.NumberFormat('en-US', {
        style: 'currency', currency: cur,
        minimumFractionDigits: 0, maximumFractionDigits: 0
    }).format(amount);

    const fmtSalaryFrom = fmtCur(salary, fromCurrency);
    const fmtSalaryTo = fmtCur(Math.round(equivalent), toCurrency);

    // === TAX & DEDUCTIONS BREAKDOWN ===
    const fromCountry = cityToCountry[fromCity];
    const toCountry = cityToCountry[toCity];
    const taxSection = document.getElementById('taxSection');
    let fromDed = null;
    let toDed = null;

    if (fromCountry && toCountry) {
        fromDed = calculateAllDeductions(salary, fromCountry, fromCity, isExpatMode, fromNhood);
        toDed = calculateAllDeductions(equivalent, toCountry, toCity, isExpatMode, toNhood);

        function buildCompactCard(label, grossFmt, ded, cur, equivNet, equivCur) {
            const maxR = Math.max(...ded.items.map(i=>i.rate), 1);
            let bars = '';
            for (const item of ded.items) {
                const bw = Math.max(Math.round((item.rate/maxR)*100), 2);
                const c = dedColors[item.key]||'#6b7280';
                bars += `<div style="display:flex;align-items:center;gap:6px;margin-bottom:5px;">
                    <div style="width:100px;font-size:0.7rem;color:#86868b;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${item.label}</div>
                    <div style="flex:1;background:#f0f0f2;border-radius:3px;height:8px;overflow:hidden;"><div style="width:${bw}%;height:100%;background:${c};border-radius:3px;"></div></div>
                    <div style="width:32px;text-align:right;font-size:0.7rem;font-weight:600;color:#1d1d1f;">${item.rate}%</div>
                </div>`;
            }
            const fmtNet = fmtCur(ded.net, cur);
            let equivLine = '';
            if (equivNet != null && equivCur && equivCur !== cur) {
                equivLine = `<div class="ded-take-home-equiv">\u2248 ${fmtCur(equivNet, equivCur)} in ${equivCur}</div>`;
            }
            return `<div class="tax-card" style="text-align:left;">
                <div class="tax-card-city">${label}</div>
                <div class="tax-card-gross">Gross: ${grossFmt}</div>
                ${bars}
                <div style="border-top:1px solid #e5e5ea;margin-top:6px;padding-top:6px;display:flex;justify-content:space-between;">
                    <span style="font-size:0.75rem;font-weight:600;">Total: ${ded.totalRate}%</span>
                    <span style="font-size:0.85rem;font-weight:700;color:#22c55e;">${fmtNet}</span>
                </div>
                ${equivLine}
                <div style="text-align:right;font-size:0.6rem;color:#86868b;">Take-Home/yr</div>
            </div>`;
        }

        const toNetInFromCurr = toDed.net / xRate;
        document.getElementById('taxGrid').innerHTML =
            buildCompactCard(fromLabel, fmtSalaryFrom, fromDed, fromCurrency) +
            buildCompactCard(toLabel, fmtSalaryTo, toDed, toCurrency, toNetInFromCurr, fromCurrency);
        taxSection.style.display = 'block';
    } else {
        taxSection.style.display = 'none';
    }

    // === ESTIMATED RENT ===
    const rentSection = document.getElementById('rentSection');
    const fromBaseRent = cityRent1BR[fromCity];
    const toBaseRent = cityRent1BR[toCity];
    let fromRentUSD = 0;
    let toRentUSD = 0;
    let hasRentData = false;
    const fromMult = (fromNhood && cityNeighborhoods[fromCity] && cityNeighborhoods[fromCity][fromNhood]) ? cityNeighborhoods[fromCity][fromNhood] : 1.0;
    const toMult = (toNhood && cityNeighborhoods[toCity] && cityNeighborhoods[toCity][toNhood]) ? cityNeighborhoods[toCity][toNhood] : 1.0;

    if (fromBaseRent && toBaseRent) {
        hasRentData = true;
        fromRentUSD = fromBaseRent * fromMult;
        toRentUSD = toBaseRent * toMult;
        const fromRentLocal = fromRentUSD * (exchangeRates[fromCurrency] / exchangeRates['USD']);
        const toRentLocal = toRentUSD * (exchangeRates[toCurrency] / exchangeRates['USD']);
        const fmtUSD = (a) => fmtCur(a, 'USD');
        function buildRentCard(label, rentLocal, rentUSD, cur) {
            const usdLine = cur !== 'USD' ? `<div class="rent-card-usd">\u2248 ${fmtUSD(rentUSD)}/mo</div>` : '';
            return `<div class="rent-card">
                <div class="rent-card-city">${label}</div>
                <div class="rent-card-amount">${fmtCur(rentLocal, cur)}</div>
                ${usdLine}
                <div class="rent-card-label">per month (1BR)</div>
            </div>`;
        }
        document.getElementById('rentGrid').innerHTML =
            buildRentCard(fromLabel, fromRentLocal, fromRentUSD, fromCurrency) +
            buildRentCard(toLabel, toRentLocal, toRentUSD, toCurrency);
        rentSection.style.display = 'block';
    } else {
        rentSection.style.display = 'none';
    }

    // === AFFORDABILITY VERDICT ===
    const affordSection = document.getElementById('affordabilitySection');
    if (fromDed && toDed && hasRentData) {
        const usdToFromRate = exchangeRates[fromCurrency] / exchangeRates['USD'];
        const fromTakeHome = fromDed.net;
        const toTakeHome = toDed.net / xRate;
        const fromAnnualRent = fromRentUSD * usdToFromRate * 12;
        const toAnnualRent = toRentUSD * usdToFromRate * 12;

        // Look up living costs
        const fromCosts = cityLivingCosts[fromCity];
        const toCosts = cityLivingCosts[toCity];
        const hasLivingCosts = fromCosts && toCosts;

        let fromDisposable, toDisposable;
        let costBreakdown = null;

        if (hasLivingCosts) {
            const fromGroceries = fromCosts.groceries * fromMult * usdToFromRate * 12;
            const toGroceries = toCosts.groceries * toMult * usdToFromRate * 12;
            const fromUtilities = fromCosts.utilities * fromMult * usdToFromRate * 12;
            const toUtilities = toCosts.utilities * toMult * usdToFromRate * 12;
            const fromTransport = fromCosts.transport * fromMult * usdToFromRate * 12;
            const toTransport = toCosts.transport * toMult * usdToFromRate * 12;
            const fromHealthcare = fromCosts.healthcare * fromMult * usdToFromRate * 12;
            const toHealthcare = toCosts.healthcare * toMult * usdToFromRate * 12;
            const fromChildcare = includeChildcare ? fromCosts.childcare * fromMult * usdToFromRate * 12 : 0;
            const toChildcare = includeChildcare ? toCosts.childcare * toMult * usdToFromRate * 12 : 0;

            const fromTotalLiving = fromGroceries + fromUtilities + fromTransport + fromHealthcare + fromChildcare;
            const toTotalLiving = toGroceries + toUtilities + toTransport + toHealthcare + toChildcare;

            fromDisposable = fromTakeHome - fromAnnualRent - fromTotalLiving;
            toDisposable = toTakeHome - toAnnualRent - toTotalLiving;

            costBreakdown = {
                from: { rent: fromAnnualRent, groceries: fromGroceries, utilities: fromUtilities, transport: fromTransport, healthcare: fromHealthcare, childcare: fromChildcare },
                to: { rent: toAnnualRent, groceries: toGroceries, utilities: toUtilities, transport: toTransport, healthcare: toHealthcare, childcare: toChildcare }
            };
        } else {
            fromDisposable = fromTakeHome - fromAnnualRent;
            toDisposable = toTakeHome - toAnnualRent;
        }

        const diffPct = fromDisposable !== 0 ? ((toDisposable - fromDisposable) / Math.abs(fromDisposable)) * 100 : 0;
        const absDiff = Math.abs(diffPct).toFixed(0);
        const costPhrase = hasLivingCosts ? 'after taxes and living costs' : 'after rent & taxes';

        let vClass, vIcon, vText;
        if (diffPct > 10) {
            vClass = 'better'; vIcon = '\uD83D\uDFE2';
            vText = `~${absDiff}% more spending power in ${toCity} ${costPhrase}`;
        } else if (diffPct < -10) {
            vClass = 'worse'; vIcon = '\uD83D\uDD34';
            vText = `~${absDiff}% less spending power in ${toCity} ${costPhrase}`;
        } else {
            vClass = 'similar'; vIcon = '\uD83D\uDFE1';
            vText = `Within ~${absDiff}% — too close to call. Consider lifestyle preferences and other factors.`;
        }

        document.getElementById('affordVerdict').className = 'afford-verdict ' + vClass;
        document.getElementById('affordVerdict').innerHTML = `<span class="afford-verdict-icon">${vIcon}</span><span>${vText}</span>`;

        function buildAffordCard(label, takeHome, costs, disposable) {
            const dc = disposable >= 0 ? 'positive' : 'negative';
            let rows = `<div class="afford-card-row"><span>Take-home/yr</span><span class="afford-card-val">${fmtCur(takeHome, fromCurrency)}</span></div>
                <div class="afford-card-row separator"><span>Rent/yr (1BR)</span><span class="afford-card-val deduction">\u2212 ${fmtCur(costs.rent, fromCurrency)}</span></div>`;

            if (hasLivingCosts) {
                rows += `<div class="afford-card-row"><span>Groceries/yr</span><span class="afford-card-val deduction">\u2212 ${fmtCur(costs.groceries, fromCurrency)}</span></div>
                    <div class="afford-card-row"><span>Utilities/yr</span><span class="afford-card-val deduction">\u2212 ${fmtCur(costs.utilities, fromCurrency)}</span></div>
                    <div class="afford-card-row"><span>Transport/yr</span><span class="afford-card-val deduction">\u2212 ${fmtCur(costs.transport, fromCurrency)}</span></div>
                    <div class="afford-card-row"><span>Healthcare/yr</span><span class="afford-card-val deduction">\u2212 ${fmtCur(costs.healthcare, fromCurrency)}</span></div>`;
                if (includeChildcare) {
                    rows += `<div class="afford-card-row"><span>Childcare/yr</span><span class="afford-card-val deduction">\u2212 ${fmtCur(costs.childcare, fromCurrency)}</span></div>`;
                }
            }

            rows += `<div class="afford-card-row total"><span>Disposable</span><span class="afford-card-val ${dc}">${fmtCur(disposable, fromCurrency)}</span></div>`;

            return `<div class="afford-card">
                <div class="afford-card-city">${label}</div>
                ${rows}
            </div>`;
        }

        const fromCostsObj = costBreakdown ? costBreakdown.from : { rent: fromAnnualRent, groceries: 0, utilities: 0, transport: 0, healthcare: 0, childcare: 0 };
        const toCostsObj = costBreakdown ? costBreakdown.to : { rent: toAnnualRent, groceries: 0, utilities: 0, transport: 0, healthcare: 0, childcare: 0 };

        document.getElementById('affordCards').innerHTML =
            buildAffordCard(fromLabel, fromTakeHome, fromCostsObj, fromDisposable) +
            buildAffordCard(toLabel, toTakeHome, toCostsObj, toDisposable);

        // Show/hide childcare toggle
        document.getElementById('childcareToggle').style.display = hasLivingCosts ? 'flex' : 'none';

        // Update note
        const noteEl = document.getElementById('affordNote');
        const sources = ' Sources: <a href="https://www.numbeo.com/cost-of-living/" target="_blank" rel="noopener">Numbeo</a>, <a href="https://data.oecd.org/healthres/health-spending.htm" target="_blank" rel="noopener">OECD</a>.';
        if (hasLivingCosts) {
            noteEl.innerHTML = 'Disposable = take-home minus rent, groceries, utilities, transport' + (includeChildcare ? ', childcare' : '') + ' &amp; healthcare. All costs adjusted for neighborhood. These living costs are already factored into the COLI (Cost of Living Index) adjusted salary above — COLI measures relative price levels across cities (New York = 100) — this breakdown shows where your money goes.' + sources;
        } else {
            noteEl.innerHTML = 'Full living cost data not available for one or both cities. Showing rent only.' + sources;
        }

        affordSection.style.display = 'block';
    } else {
        affordSection.style.display = 'none';
    }

    // === VISUAL CHART ===
    const chartSection = document.getElementById('chartSection');
    const maxSal = Math.max(salary, equivalent);
    const fromPct = (salary / maxSal) * 100;
    const toPct = (equivalent / maxSal) * 100;

    let chartHTML = `
        <div class="chart-bar-row">
            <div class="chart-bar-label">${fromCity}</div>
            <div class="chart-bar-track">
                <div class="chart-bar-fill current" style="width: ${fromPct}%">${fmtSalaryFrom}</div>
            </div>
        </div>
        <div class="chart-bar-row">
            <div class="chart-bar-label">${toCity}</div>
            <div class="chart-bar-track">
                <div class="chart-bar-fill target" style="width: ${toPct}%">${fmtSalaryTo}</div>
            </div>
        </div>
    `;

    if (fromDed && toDed) {
        const netFromVal = fromDed.net;
        const netToVal = toDed.net;
        const maxNet = Math.max(netFromVal, netToVal);
        const netFromPct = (netFromVal / maxNet) * 100;
        const netToPct = (netToVal / maxNet) * 100;
        chartHTML += `
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e8e8ed;">
                <div style="font-size: 0.6rem; color: #86868b; margin-bottom: 6px; font-weight: 500;">AFTER TAX (ESTIMATED)</div>
            </div>
            <div class="chart-bar-row">
                <div class="chart-bar-label">${fromCity}</div>
                <div class="chart-bar-track">
                    <div class="chart-bar-fill tax-current" style="width: ${netFromPct}%">${fmtCur(netFromVal, fromCurrency)}</div>
                </div>
            </div>
            <div class="chart-bar-row">
                <div class="chart-bar-label">${toCity}</div>
                <div class="chart-bar-track">
                    <div class="chart-bar-fill tax-target" style="width: ${netToPct}%">${fmtCur(netToVal, toCurrency)}</div>
                </div>
            </div>
        `;
    }

    document.getElementById('chartBars').innerHTML = chartHTML;
    chartSection.style.display = 'block';

    // === SALARY RANGES BY ROLE ===
    const rangesSection = document.getElementById('salaryRangesSection');
    const rangesList = document.getElementById('rangesList');
    const targetExRate = exchangeRates[toCurrency] / exchangeRates['USD'];
    const targetColiAdj = coliData[toCity] / 100;
    let rangesHTML = '';

    Object.entries(salaryRanges).forEach(([title, range]) => {
        const adjLow = range.low * targetColiAdj * targetExRate;
        const adjMid = range.mid * targetColiAdj * targetExRate;
        const adjHigh = range.high * targetColiAdj * targetExRate;

        const fmtLow = new Intl.NumberFormat('en-US', {
            style: 'currency', currency: toCurrency,
            minimumFractionDigits: 0, maximumFractionDigits: 0, notation: 'compact'
        }).format(adjLow);
        const fmtMid = new Intl.NumberFormat('en-US', {
            style: 'currency', currency: toCurrency,
            minimumFractionDigits: 0, maximumFractionDigits: 0, notation: 'compact'
        }).format(adjMid);
        const fmtHigh = new Intl.NumberFormat('en-US', {
            style: 'currency', currency: toCurrency,
            minimumFractionDigits: 0, maximumFractionDigits: 0, notation: 'compact'
        }).format(adjHigh);

        const maxHigh = Math.max(...Object.values(salaryRanges).map(r => r.high * targetColiAdj * targetExRate));
        const barLeft = (adjLow / maxHigh) * 100;
        const barWidth = ((adjHigh - adjLow) / maxHigh) * 100;

        rangesHTML += `<div class="range-item">
            <div class="range-item-title">${title}</div>
            <div class="range-item-bar"><div class="range-item-bar-fill" style="left:${barLeft}%;width:${barWidth}%;"></div></div>
            <div class="range-item-mid">${fmtMid}</div>
            <div class="range-item-values"><span>${fmtLow}</span><span>${fmtHigh}</span></div>
        </div>`;
    });

    rangesList.innerHTML = rangesHTML;
    rangesSection.style.display = 'block';

    // === HOW WE CALCULATED THIS ===
    const baseCOLIFrom = coliData[fromCity];
    const baseCOLITo = coliData[toCity];
    const fmtConverted = fmtCur(salary * xRate, toCurrency);
    const colRatioVal = toCOLI / fromCOLI;

    let stepNum = 1;
    let stepsHTML = '';

    // Step 1: Your salary
    stepsHTML += `<div class="explanation-step"><div class="step-num">${stepNum++}</div><div class="step-text"><strong>Your salary:</strong> ${fmtSalaryFrom} in ${fromLabel} (${fromCurrency})</div></div>`;

    // Step 2: Currency conversion
    stepsHTML += `<div class="explanation-step"><div class="step-num">${stepNum++}</div><div class="step-text"><strong>Currency conversion:</strong> ${fmtSalaryFrom} → ${fmtConverted} at a rate of 1 ${fromCurrency} = ${xRate.toFixed(4)} ${toCurrency}</div></div>`;

    // Step 3: City cost of living
    const colRatioText = (!fromNhood && !toNhood) ? ` The ratio is <strong>${colRatioVal.toFixed(2)}x</strong>.` : '';
    stepsHTML += `<div class="explanation-step"><div class="step-num">${stepNum++}</div><div class="step-text"><strong>City cost of living:</strong> ${fromCity} has a base cost index of <strong>${baseCOLIFrom}</strong> and ${toCity} has <strong>${baseCOLITo}</strong> (New York = 100 baseline).${colRatioText}</div></div>`;

    // Step 4: Neighborhood adjustments (if applicable)
    if (fromNhood || toNhood) {
        let nhoodText = '<strong>Neighborhood adjustment:</strong> ';
        const parts = [];
        if (fromNhood && cityNeighborhoods[fromCity] && cityNeighborhoods[fromCity][fromNhood]) {
            const m = cityNeighborhoods[fromCity][fromNhood];
            const pct = ((m - 1) * 100).toFixed(0);
            const sign = pct >= 0 ? '+' : '';
            parts.push(`${fromNhood} in ${fromCity} is ${sign}${pct}% vs the city average (adjusted COLI: ${(baseCOLIFrom * m).toFixed(1)})`);
        }
        if (toNhood && cityNeighborhoods[toCity] && cityNeighborhoods[toCity][toNhood]) {
            const m = cityNeighborhoods[toCity][toNhood];
            const pct = ((m - 1) * 100).toFixed(0);
            const sign = pct >= 0 ? '+' : '';
            parts.push(`${toNhood} in ${toCity} is ${sign}${pct}% vs the city average (adjusted COLI: ${(baseCOLITo * m).toFixed(1)})`);
        }
        nhoodText += parts.join('. ') + '.';
        stepsHTML += `<div class="explanation-step"><div class="step-num">${stepNum++}</div><div class="step-text">${nhoodText}</div></div>`;
    }

    // Step N: Final formula
    let formulaText = `${fmtSalaryFrom} × ${colRatioVal.toFixed(2)} (cost of living`;
    if (fromNhood || toNhood) formulaText += ', incl. neighborhood';
    formulaText += `) × ${xRate.toFixed(2)} (exchange rate) = <strong>${fmtSalaryTo}</strong>`;
    stepsHTML += `<div class="explanation-step"><div class="step-num">${stepNum++}</div><div class="step-text"><strong>Final formula:</strong> ${formulaText}</div></div>`;

    // Step N+1: What this means
    stepsHTML += `<div class="explanation-step"><div class="step-num">${stepNum++}</div><div class="step-text"><strong>What this means:</strong> To maintain the same purchasing power you have with ${fmtSalaryFrom} in ${fromLabel}, you would need ${fmtSalaryTo} in ${toLabel}.</div></div>`;

    document.getElementById('explanationSteps').innerHTML = stepsHTML;
    document.getElementById('explanationSection').style.display = 'block';

    resultBox.style.display = 'block';
    resultBox.style.animation = 'none';
    resultBox.offsetHeight;
    resultBox.style.animation = 'slideIn 0.4s ease-out';
}

init();
</script>

</body>
</html>
